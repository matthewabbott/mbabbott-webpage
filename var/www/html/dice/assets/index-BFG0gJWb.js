var Ft=Object.defineProperty;var Ut=(a,e,t)=>e in a?Ft(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var $=(a,e,t)=>Ut(a,typeof e!="symbol"?e+"":e,t);import{j as r,a as g,b as se,V as M,Q as Y,M as Lt,B as re,F as Fe,c as _t,D as Ht,d as Bt,C as ct,L as Ge,e as Ot,E as Ne,f as U,u as ke,h as et,H as dt,i as qt,k as Gt,O as Qt,l as Wt,m as Yt,n as Kt}from"./three-00UeVYYZ.js";import{P as Xt,a as Ue,b as tt}from"./ui-DZYS9jEh.js";import{g as K,u as Se,a as Me,b as ye,_ as Zt,O as ut,c as st,p as Jt,A as es,d as ht,i as mt,H as ts,f as ss,e as ns,s as os,h as rs,j as as,I as is,k as ls}from"./graphql-NwjbXysq.js";import{V as S,W as cs,N as nt,G as ds,S as us,M as Le,C as _e,Q as O,a as We,T as hs,B as Ye,b as gt,c as ms,P as gs,d as me}from"./physics-CHtaqm8R.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function t(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=t(n);fetch(n.href,o)}})();const ps=K`
  mutation RegisterUsername($username: String!) {
    registerUsername(username: $username) {
      success
      username
      message
    }
  }
`,fs=K`
  mutation RollDice($expression: String!) {
    rollDice(expression: $expression) {
      expression
      results
      total
      canvasData {
        dice {
          canvasId
          diceType
          position {
            x
            y
            z
          }
          isVirtual
          virtualRolls
          result
        }
        events {
          id
          type
          diceId
          userId
          timestamp
          data {
            position {
              x
              y
              z
            }
            velocity {
              x
              y
              z
            }
      result
            diceType
            isVirtual
            virtualRolls
            highlightColor
          }
        }
      }
    }
  }
`,xs=K`
  mutation SetUserColor($color: String!) {
    setUserColor(color: $color) {
      success
      color
      message
    }
  }
`,ys=K`
  mutation SendChatMessage($message: String!) {
    sendChatMessage(message: $message) {
      id
      type
      timestamp
      user
      message
    }
  }
`;K`
  query GetActivities {
    activities {
      id
      type
      timestamp
      user
      message
      roll {
        expression
        results
        total
        canvasData {
          dice {
            canvasId
            diceType
            position {
              x
              y
              z
            }
            isVirtual
            virtualRolls
        result
          }
          events {
            id
            type
            diceId
            userId
            timestamp
          }
        }
      }
    }
  }
`;const bs=K`
  subscription ActivityAdded {
    activityAdded {
      id
      type
      timestamp
      user
      message
      roll {
        expression
        results
        total
        canvasData {
          dice {
            canvasId
            diceType
            position {
              x
              y
              z
            }
            isVirtual
            virtualRolls
        result
          }
          events {
            id
            type
            diceId
            userId
            timestamp
          }
        }
      }
    }
  }
`,Ie=K`
  query GetActiveUsers {
    activeUsers {
      sessionId
      username
      color
      isActive
    }
  }
`,Ke=K`
  subscription UserListChanged {
    userListChanged {
      sessionId
      username
      color
      isActive
    }
  }
`,ws=K`
  subscription CanvasEventsUpdated {
    canvasEventsUpdated {
      id
      type
      diceId
      userId
      timestamp
      data {
        position {
          x
          y
          z
        }
        velocity {
          x
          y
          z
        }
        result
        diceType
        isVirtual
        virtualRolls
        highlightColor
      }
    }
  }
`,vs=()=>r.jsx("header",{className:"text-center py-4 bg-brand-background text-brand-text",children:r.jsx("h1",{className:"text-2xl font-bold",children:"TTRPG Dice Roller"})}),ot=["#3B82F6","#EF4444","#10B981","#F59E0B","#8B5CF6","#EC4899","#06B6D4","#84CC16","#F97316","#6366F1","#14B8A6","#F43F5E"],Ds=({currentColor:a,onColorChange:e})=>{const[t,s]=g.useState(a||ot[0]),[n,o]=g.useState(""),[i,u]=g.useState(!1),[c,h]=g.useState(!1),[d,f]=g.useState(null),[p,l]=g.useState("idle"),[m,{loading:x}]=Se(xs,{onCompleted:j=>{console.log("Color mutation completed:",j);const{success:P,color:R,message:V}=j.setUserColor;P?(s(R),l("success"),e==null||e(R)):l("error"),f(V)},onError:j=>{console.error("Color mutation error:",j),l("error"),f("Error updating color. Please try again.")}}),v=j=>/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(j),N=j=>{s(j),u(!1),o(""),I(j)},k=()=>{if(!v(n)){f("Please enter a valid hex color (e.g., #FF0000)"),l("error");return}s(n),u(!1),I(n)},I=j=>{l("loading"),f("Updating color..."),m({variables:{color:j}})},T=()=>{switch(p){case"success":return"text-green-500";case"error":return"text-red-500";case"loading":return"text-yellow-500";default:return"text-brand-text-muted"}};return r.jsxs("div",{className:"space-y-2",children:[r.jsxs("div",{className:"flex items-center space-x-2",children:[r.jsx("label",{className:"block text-sm font-medium text-brand-text-muted",children:"Color:"}),r.jsxs("button",{className:"flex items-center space-x-2 hover:opacity-80 transition-opacity",onClick:()=>h(!c),disabled:x,children:[r.jsx("div",{className:"w-6 h-6 rounded border-2 border-brand-surface",style:{backgroundColor:t},title:`Current color: ${t} (click to change)`}),r.jsx("span",{className:"text-xs text-brand-text-muted",children:c?"â–¼":"â–¶"})]})]}),c&&r.jsxs("div",{className:"space-y-3 pl-4 border-l-2 border-brand-surface",children:[r.jsx("div",{className:"grid grid-cols-6 gap-1",children:ot.map(j=>r.jsx("button",{className:`w-8 h-8 rounded border-2 hover:scale-110 transition-transform ${t===j?"border-brand-text":"border-brand-surface"}`,style:{backgroundColor:j},onClick:()=>N(j),disabled:x,title:`Select color ${j}`,"aria-label":`Select color ${j}`},j))}),r.jsx("button",{className:"text-sm text-brand-text-muted hover:text-brand-text underline",onClick:()=>u(!i),disabled:x,children:i?"Hide custom color":"Use custom color"}),i&&r.jsx("div",{className:"space-y-2",children:r.jsxs("div",{className:"flex space-x-2",children:[r.jsx("input",{type:"text",className:"input-field flex-grow text-sm",placeholder:"#FF0000",value:n,onChange:j=>o(j.target.value.toUpperCase()),disabled:x}),r.jsx("button",{className:"btn-secondary px-3 py-1 text-sm",onClick:k,disabled:x||!n,children:"Apply"})]})}),d&&r.jsxs("p",{className:`text-xs ${T()}`,children:[p==="loading"&&r.jsx("span",{className:"inline-block animate-pulse mr-1",children:"â‹¯"}),d]})]})]})},L=[];for(let a=0;a<256;++a)L.push((a+256).toString(16).slice(1));function Cs(a,e=0){return(L[a[e+0]]+L[a[e+1]]+L[a[e+2]]+L[a[e+3]]+"-"+L[a[e+4]]+L[a[e+5]]+"-"+L[a[e+6]]+L[a[e+7]]+"-"+L[a[e+8]]+L[a[e+9]]+"-"+L[a[e+10]]+L[a[e+11]]+L[a[e+12]]+L[a[e+13]]+L[a[e+14]]+L[a[e+15]]).toLowerCase()}let He;const js=new Uint8Array(16);function Ss(){if(!He){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");He=crypto.getRandomValues.bind(crypto)}return He(js)}const Ns=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),rt={randomUUID:Ns};function ks(a,e,t){var n;if(rt.randomUUID&&!a)return rt.randomUUID();a=a||{};const s=a.random??((n=a.rng)==null?void 0:n.call(a))??Ss();if(s.length<16)throw new Error("Random bytes length must be >= 16");return s[6]=s[6]&15|64,s[8]=s[8]&63|128,Cs(s)}const Te=()=>{let a=localStorage.getItem("dice-roller-session-id");return a||(a=ks(),localStorage.setItem("dice-roller-session-id",a)),a},Ms=({onQuickRoll:a,hideQuickRollCommands:e=!1,showOnlyUserSettings:t=!1})=>{const[s,n]=g.useState("Anonymous"),[o,i]=g.useState(""),[u,c]=g.useState(!0),[h,d]=g.useState(null),[f,p]=g.useState("idle"),[l,m]=g.useState("#ffffff"),[x,v]=g.useState([]),[N,k]=g.useState(!1),I=Te(),T=g.useRef(null);Me(Ie,{onCompleted:y=>{v(y.activeUsers);const C=y.activeUsers.find(E=>E.sessionId===I);C&&(C.username&&(n(C.username),i(C.username),c(!0)),C.color&&m(C.color))}}),ye(Ke,{onData:({data:y})=>{var E;const C=(E=y==null?void 0:y.data)==null?void 0:E.userListChanged;if(C){v(C);const A=C.find(Q=>Q.sessionId===I);A&&(A.username&&A.username!==s&&(n(A.username),i(A.username),c(!0)),A.color&&m(A.color))}}});const[j,{loading:P}]=Se(ps,{onCompleted:y=>{console.log("Username registration completed:",y);const{success:C,username:E,message:A}=y.registerUsername;C?(n(E),c(!0),p("success")):(c(!1),p("error")),d(A)},onError:y=>{console.error("Username registration error:",y),c(!1),p("error"),d("Error registering username. Please try again.")}}),R=g.useCallback(y=>{(!y||y==="")&&(y="Anonymous"),j({variables:{username:y}})},[j]);g.useEffect(()=>(T.current&&clearTimeout(T.current),o&&o!==s&&o!=="Anonymous"&&(T.current=setTimeout(()=>{R(o)},1e3)),()=>{T.current&&clearTimeout(T.current)}),[o,s,R]);const V=y=>{let C=y.target.value;const E=/[^a-zA-Z0-9 _'.-]/g;C=C.replace(E,"");const A=60;C.length>A&&(C=C.slice(0,A)),i(C),C==="Anonymous"?(n("Anonymous"),c(!0),p("success"),d("Using Anonymous name.")):c(!1)},z=y=>{const C=`/roll 1d${y}`;a&&a(C)},D=()=>{switch(f){case"success":return"text-green-500";case"error":return"text-red-500";case"loading":return"text-yellow-500";default:return"text-brand-text-muted"}},b=[4,6,8,10,12,20];return r.jsxs("div",{className:e?"":"card",children:[!e&&!t&&r.jsx("h2",{className:"text-xl font-semibold text-brand-text mb-3",children:"User Settings"}),r.jsxs("div",{className:"mb-3",children:[r.jsx("label",{htmlFor:"username",className:"block text-sm font-medium text-brand-text-muted mb-1",children:"Username"}),r.jsxs("div",{className:"space-y-1",children:[r.jsx("input",{type:"text",id:"username",className:`input-field w-full ${!u&&s!=="Anonymous"?"border-red-500":""}`,placeholder:"Enter your name",value:o||s,onChange:V,disabled:P}),h&&r.jsxs("p",{className:`text-xs ${D()}`,children:[f==="loading"&&r.jsx("span",{className:"inline-block animate-pulse mr-1",children:"â‹¯"}),h]})]})]}),r.jsx("div",{className:e?"":"mb-4",children:r.jsx(Ds,{currentColor:l,onColorChange:m})}),e&&!t&&r.jsxs("div",{className:"mt-4",children:[r.jsxs("h4",{className:"text-sm font-medium text-brand-text-muted mb-3",children:["Active Players (",x.length,")"]}),r.jsxs("div",{className:"space-y-2",children:[x.map(y=>r.jsxs("div",{className:"flex items-center gap-2 p-2 bg-brand-surface rounded",children:[r.jsx("div",{className:"w-3 h-3 rounded-full border border-gray-400",style:{backgroundColor:y.color||"#ffffff"},title:`${y.username}'s color`}),r.jsx("span",{className:"text-brand-text text-sm",children:y.username}),y.isActive&&r.jsx("span",{className:"text-xs text-green-400 bg-green-900/30 px-2 py-1 rounded",children:"Online"})]},y.sessionId)),x.length===0&&r.jsx("div",{className:"text-center text-brand-text-muted text-sm py-4",children:"No players connected"})]})]}),!e&&!t&&r.jsxs("div",{className:"border-t border-brand-surface pt-3",children:[r.jsxs("button",{onClick:()=>k(!N),className:"w-full flex items-center justify-between p-2 hover:bg-brand-surface rounded transition-colors",title:"Quick roll commands that generate shared dice visible to all players",children:[r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("span",{className:"text-sm font-medium text-brand-text-muted",children:"Quick Roll Commands"}),r.jsx("span",{className:"text-xs bg-blue-900/30 text-blue-300 px-2 py-1 rounded border border-blue-500/30",children:"Shared Dice"})]}),r.jsx("span",{className:"text-brand-text-muted",children:N?"â–¼":"â–¶"})]}),N&&r.jsxs("div",{className:"mt-3 space-y-3",children:[r.jsx("div",{className:"p-3 bg-blue-900/20 rounded border-l-4 border-blue-500",children:r.jsxs("div",{className:"flex items-start gap-2",children:[r.jsx("span",{className:"text-blue-400 text-sm",children:"ðŸŽ²"}),r.jsxs("div",{className:"text-xs text-blue-300",children:[r.jsx("strong",{children:"Shared Dice Commands:"})," These buttons generate ",r.jsx("code",{children:"/roll"})," commands that create dice visible to all players in the session. Results appear in chat and on the canvas."]})]})}),r.jsxs("div",{children:[r.jsx("h3",{className:"text-sm font-medium text-brand-text-muted mb-2",children:"Quick Roll Commands"}),r.jsx("div",{className:"grid grid-cols-3 gap-2",children:b.map(y=>r.jsxs("button",{className:"btn-primary px-3 py-2 text-sm",onClick:()=>z(y),title:`Roll 1d${y} - creates shared dice visible to all players`,children:["ðŸŽ² d",y]},y))}),r.jsxs("p",{className:"text-xs text-brand-text-muted mt-2",children:["ðŸ’¡ These create ",r.jsx("code",{children:"/roll"})," commands for dice shared with all players"]})]})]})]})]})};let ae={highlightedActivityId:null,highlightedDiceIds:new Set},De=[];const at=new Set;let Be=null,Oe=null;const Ee=()=>{const[a,e]=g.useState(ae),t=g.useCallback(l=>{e(l)},[]);at.add(t);const s=g.useCallback(l=>{ae=l,at.forEach(m=>m(l))},[]),n=g.useCallback(l=>{De=l},[]),o=g.useCallback(l=>{Be=l},[]),i=g.useCallback(l=>{Oe=l},[]),u=g.useCallback((l,m)=>{var k,I;if(ae.highlightedActivityId===l){s({highlightedActivityId:null,highlightedDiceIds:new Set}),console.log(`ðŸŽ¯ Cleared highlight for activity ${l}`);return}const v=(m||De).find(T=>T.id===l);if(!((I=(k=v==null?void 0:v.roll)==null?void 0:k.canvasData)!=null&&I.dice)){console.warn(`No dice found for activity ${l}`),s({highlightedActivityId:l,highlightedDiceIds:new Set});return}const N=v.roll.canvasData.dice.map(T=>T.canvasId);if(s({highlightedActivityId:l,highlightedDiceIds:new Set(N)}),console.log(`ðŸŽ¯ Highlighted activity ${l} with ${N.length} dice:`,N),N.length>0&&Be&&Oe){const T=N[0],j=Oe(T);j&&(Be(j),console.log(`ðŸ“· Camera jumped to dice ${T} at position:`,j))}},[s]),c=g.useCallback((l,m)=>{var I,T,j;if(ae.highlightedDiceIds.has(l)){s({highlightedActivityId:null,highlightedDiceIds:new Set}),console.log(`ðŸŽ¯ Cleared highlight for dice ${l}`);return}const x=m||De;console.log(`ðŸ” Looking for dice ${l} in ${x.length} activities`);const v=x.flatMap(P=>{var R,V,z;return((z=(V=(R=P.roll)==null?void 0:R.canvasData)==null?void 0:V.dice)==null?void 0:z.map(D=>D.canvasId))||[]});console.log("ðŸ” Available dice IDs:",v);const N=x.find(P=>{var R,V,z;return(z=(V=(R=P.roll)==null?void 0:R.canvasData)==null?void 0:V.dice)==null?void 0:z.some(D=>D.canvasId===l)});if(!N){console.warn(`No activity found for dice ${l}`),s({highlightedActivityId:null,highlightedDiceIds:new Set([l])});return}const k=((j=(T=(I=N.roll)==null?void 0:I.canvasData)==null?void 0:T.dice)==null?void 0:j.map(P=>P.canvasId))||[];s({highlightedActivityId:N.id,highlightedDiceIds:new Set(k)}),console.log(`ðŸŽ¯ Highlighted dice ${l} -> activity ${N.id} with ${k.length} dice:`,k)},[s]),h=g.useCallback(()=>{s({highlightedActivityId:null,highlightedDiceIds:new Set}),console.log("ðŸŽ¯ Cleared all highlights")},[s]),d=g.useCallback(l=>ae.highlightedActivityId===l,[]),f=g.useCallback(l=>ae.highlightedDiceIds.has(l),[]),p=g.useCallback(()=>De,[]);return{highlightState:a,setActivities:n,setCameraJumpCallback:o,setGetDicePositionCallback:i,highlightFromActivity:u,highlightFromDice:c,clearHighlight:h,isActivityHighlighted:d,isDiceHighlighted:f,getActivities:p}};class W{static parseMessage(e){const t=e.trim();if(!t.startsWith("/"))return{isCommand:!1,originalText:e};const n=t.slice(1).split(/\s+/),o=n[0].toLowerCase(),i=n.slice(1);return this.ROLL_COMMANDS.includes(o)?this.parseRollCommand(o,i,e):this.HELP_COMMANDS.includes(o)?this.parseHelpCommand(o,i,e):{isCommand:!0,command:o,args:i,originalText:e,error:`Unknown command: /${o}. Type /help for available commands.`}}static parseRollCommand(e,t,s){if(t.length===0)return{isCommand:!0,command:e,args:t,originalText:s,error:"Roll command requires a dice expression. Example: /roll 2d6"};const n=t.join(" "),o=this.validateDiceExpression(n);return o?{isCommand:!0,command:e,args:t,originalText:s,diceExpression:n,error:o}:{isCommand:!0,command:e,args:t,originalText:s,diceExpression:n}}static parseHelpCommand(e,t,s){return{isCommand:!0,command:e,args:t,originalText:s}}static validateDiceExpression(e){const t=e.replace(/\s+/g,""),s=/^(\d+)?d(\d+)$/i;if(!s.test(t))return`Invalid dice expression: "${e}". Use format like "2d6", "d20", "1d100".`;const n=t.match(s);if(n){const o=n[1]?parseInt(n[1],10):1,i=parseInt(n[2],10);if(o<=0)return"Number of dice must be greater than 0.";if(i<=0)return"Die type must be greater than 0.";if(o>1e4)return"Maximum 10,000 dice allowed per roll.";if(i>1e6)return"Maximum die type is 1,000,000 sides."}return null}static getHelp(e){const t=[{command:"roll",aliases:["r","dice","d"],description:"Roll dice with the specified expression",usage:"/roll <dice_expression>",examples:["/roll 2d6","/r d20","/dice 3d8","/d 1d100"]},{command:"help",aliases:["h","?"],description:"Show help information for commands",usage:"/help [command]",examples:["/help","/help roll","/h","/? roll"]}];if(e){const s=t.find(n=>n.command===e.toLowerCase()||n.aliases.includes(e.toLowerCase()));return s?[s]:[]}return t}static formatHelp(e){if(e.length===0)return"No help available for that command.";if(e.length===1){const s=e[0],n=s.aliases.length>0?` (aliases: ${s.aliases.map(o=>`/${o}`).join(", ")})`:"";return`**/${s.command}**${n}
${s.description}

**Usage:** ${s.usage}

**Examples:**
${s.examples.map(o=>`â€¢ ${o}`).join(`
`)}`}let t=`**Available Commands:**

`;return e.forEach(s=>{const n=s.aliases.length>0?` (${s.aliases.map(o=>`/${o}`).join(", ")})`:"";t+=`**/${s.command}**${n} - ${s.description}
`}),t+="\nType `/help <command>` for detailed usage information.",t}static isCommand(e){return e.trim().startsWith("/")}static getSupportedCommands(){return[...this.ROLL_COMMANDS,...this.HELP_COMMANDS]}}$(W,"ROLL_COMMANDS",["roll","r","dice","d"]),$(W,"HELP_COMMANDS",["help","h","?"]);const pt=g.forwardRef(({hideHeader:a=!1,onDiceButtonClick:e},t)=>{const[s,n]=g.useState(""),[o,i]=g.useState(!1),[u,c]=g.useState(null),[h,d]=g.useState(null),f=g.useRef(null),p=Te(),{data:l}=Me(Ie),m=l==null?void 0:l.activeUsers.find(b=>b.sessionId===p),x=(m==null?void 0:m.username)||"Anonymous";g.useImperativeHandle(t,()=>({populateCommand:b=>{n(b),P({target:{value:b}})}}));const[v,{loading:N,error:k}]=Se(ys,{onCompleted:()=>{console.log("Chat message sent successfully"),n(""),i(!1),c(null),d(null),setTimeout(()=>{var b;(b=f.current)==null||b.focus()},1)},onError:b=>{console.error("Chat message error:",b),i(!1)}}),[I,{loading:T,error:j}]=Se(fs,{onCompleted:b=>{console.log("Dice roll completed:",b),n(""),i(!1),c(null),d(null),setTimeout(()=>{var y;(y=f.current)==null||y.focus()},1)},onError:b=>{console.error("Dice roll error:",b),i(!1)}}),P=b=>{const y=b.target.value;if(n(y),W.isCommand(y)){const C=W.parseMessage(y);C.error?(d(C.error),c(null)):(d(null),C.command==="roll"||C.command==="r"||C.command==="dice"||C.command==="d"?c(`ðŸŽ² Roll ${C.diceExpression} as ${x}`):C.command==="help"||C.command==="h"||C.command==="?"?C.args&&C.args.length>0?c(`â“ Show help for: ${C.args[0]}`):c("â“ Show all available commands"):c(`âš¡ Execute command: /${C.command}`))}else c(null),d(null)},R=b=>{b.preventDefault();const y=s.trim();if(!y||o)return;i(!0);const C=f.current;if(W.isCommand(y)){const E=W.parseMessage(y);if(E.error){d(E.error),i(!1),setTimeout(()=>C==null?void 0:C.focus(),10);return}if(E.command==="roll"||E.command==="r"||E.command==="dice"||E.command==="d"){E.diceExpression?I({variables:{expression:E.diceExpression}}):(d("Roll command requires a dice expression"),i(!1),setTimeout(()=>C==null?void 0:C.focus(),10));return}if(E.command==="help"||E.command==="h"||E.command==="?"){const A=E.args&&E.args.length>0?W.getHelp(E.args[0]):W.getHelp(),Q=W.formatHelp(A);v({variables:{message:Q}});return}d(E.error||"Unknown command"),i(!1),setTimeout(()=>C==null?void 0:C.focus(),10);return}v({variables:{message:y}})},V=b=>{b.key==="Enter"&&!b.shiftKey&&(b.preventDefault(),R(b))},z=N||T||o,D=k||j;return r.jsxs("div",{className:"card",children:[!a&&r.jsx("h3",{className:"text-lg font-semibold text-brand-text mb-3",children:"Send Message"}),r.jsx("form",{onSubmit:R,className:"space-y-2",children:r.jsxs("div",{className:"flex space-x-2",children:[r.jsxs("div",{className:"relative flex-grow",children:[r.jsx("input",{ref:f,type:"text",className:`input-field w-full pr-8 transition-colors ${h?"border-orange-500 bg-orange-900/10":D?"border-red-500 bg-red-900/10":u?"border-blue-500 bg-blue-900/10":""}`,placeholder:"Chat or /roll",value:s,onChange:P,onKeyPress:V,disabled:z,maxLength:1e3}),r.jsxs("div",{className:"absolute top-1 right-1 flex items-center space-x-1",children:[u&&r.jsxs("div",{className:"relative group",children:[r.jsx("div",{className:"text-sm cursor-help",children:"ðŸŽ²"}),r.jsx("div",{className:"absolute bottom-6 right-0 bg-brand-surface border border-brand-primary rounded-lg p-3 text-sm text-brand-text-muted opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-20 min-w-48 max-w-80",children:r.jsxs("div",{className:"break-words",children:[r.jsx("span",{className:"font-medium",children:"Preview:"})," ",u]})})]}),h&&r.jsxs("div",{className:"relative group",children:[r.jsx("div",{className:"text-sm cursor-help animate-pulse",children:"âš ï¸"}),r.jsx("div",{className:"absolute bottom-6 right-0 bg-orange-900/90 border border-orange-500 rounded-lg p-3 text-sm text-orange-300 opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-20 min-w-48 max-w-80",children:r.jsxs("div",{className:"break-words",children:[r.jsx("span",{className:"font-medium",children:"Warning:"})," ",h]})})]}),D&&r.jsxs("div",{className:"relative group",children:[r.jsx("div",{className:"text-sm cursor-help animate-pulse",children:"âŒ"}),r.jsx("div",{className:"absolute bottom-6 right-0 bg-red-900/90 border border-red-500 rounded-lg p-3 text-sm text-red-300 opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-20 min-w-48 max-w-80",children:r.jsxs("div",{className:"break-words",children:[r.jsx("span",{className:"font-medium",children:"Error:"})," ",D.message]})})]}),!s&&!u&&!h&&!D&&r.jsxs("div",{className:"relative group",children:[r.jsx("div",{className:"text-sm cursor-help opacity-60",children:"ðŸ’¡"}),r.jsx("div",{className:"absolute bottom-6 right-0 bg-brand-surface border border-brand-primary rounded-lg p-3 text-xs text-brand-text-muted opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-20 min-w-48 max-w-80",children:r.jsxs("div",{className:"break-words",children:["Try ",r.jsx("code",{children:"/roll 2d6"}),", ",r.jsx("code",{children:"/r d20"}),", or ",r.jsx("code",{children:"/help"})," for commands"]})})]})]})]}),e&&r.jsx("button",{type:"button",className:"btn-secondary px-3 py-2 text-lg",onClick:e,disabled:z,title:"Quick dice roll commands",children:"ðŸŽ²"}),r.jsx("button",{type:"submit",className:"btn-primary px-4 py-2",disabled:z||!s.trim(),children:z?"Sending...":"Send"})]})})]})});pt.displayName="ChatInput";const Is=({isOpen:a,onClose:e,onQuickRoll:t})=>{g.useEffect(()=>{const i=u=>{u.key==="Escape"&&e()};return a&&(document.addEventListener("keydown",i),document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",i),document.body.style.overflow="unset"}},[a,e]);const s=i=>{const u=`/roll 1d${i}`;t(u),e()},n=i=>{i.target===i.currentTarget&&e()};if(!a)return null;const o=[{type:4,emoji:"â–²",name:"D4",color:"bg-slate-600 hover:bg-slate-500"},{type:6,emoji:"â¬œ",name:"D6",color:"bg-slate-600 hover:bg-slate-500"},{type:8,emoji:"ðŸ”¸",name:"D8",color:"bg-slate-600 hover:bg-slate-500"},{type:10,emoji:"ðŸ”Ÿ",name:"D10",color:"bg-slate-600 hover:bg-slate-500"},{type:12,emoji:"â¬¡",name:"D12",color:"bg-slate-600 hover:bg-slate-500"},{type:20,emoji:"ðŸ”´",name:"D20",color:"bg-slate-600 hover:bg-slate-500"}];return r.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50",onClick:n,children:r.jsxs("div",{className:"bg-brand-surface rounded-lg shadow-xl border border-white/10 p-6 max-w-md w-full mx-4",children:[r.jsxs("div",{className:"flex justify-between items-center mb-4",children:[r.jsx("h3",{className:"text-lg font-semibold text-brand-text flex items-center gap-2",children:"ðŸŽ² Quick Roll Commands"}),r.jsx("button",{onClick:e,className:"text-brand-text-muted hover:text-brand-text transition-colors",title:"Close modal (Esc)",children:"âœ•"})]}),r.jsx("div",{className:"p-3 bg-blue-900/20 rounded border-l-4 border-blue-500 mb-4",children:r.jsxs("div",{className:"flex items-start gap-2",children:[r.jsx("span",{className:"text-blue-400 text-sm",children:"ðŸŽ²"}),r.jsxs("div",{className:"text-xs text-blue-300",children:[r.jsx("strong",{children:"Shared Dice Commands:"})," These buttons generate dice visible to all players in the session."]})]})}),r.jsx("div",{className:"grid grid-cols-2 gap-3",children:o.map(i=>r.jsxs("button",{onClick:()=>s(i.type),className:`
                ${i.color} 
                text-white 
                px-4 
                py-3 
                rounded-lg 
                font-medium 
                transition-colors 
                flex 
                items-center 
                justify-center 
                gap-2
              `,title:`Roll 1d${i.type} - creates shared dice visible to all players`,children:[r.jsx("span",{className:"text-lg",children:i.emoji}),r.jsx("span",{children:i.name})]},i.type))}),r.jsx("div",{className:"mt-4 text-center",children:r.jsxs("p",{className:"text-xs text-brand-text-muted",children:["Press ",r.jsx("kbd",{className:"bg-brand-background px-1 rounded",children:"Esc"})," to close"]})})]})})},Ts=({onQuickRoll:a,chatInputRef:e})=>{const[t,s]=g.useState([]),[n,o]=g.useState([]),[i,u]=g.useState(!0),[c,h]=g.useState(!0),[d,f]=g.useState(!0),[p,l]=g.useState(!1),[m,x]=g.useState(()=>{const D=localStorage.getItem("dice-roller-auto-scroll");return D!==null?JSON.parse(D):!0}),v=g.useRef(null),{highlightFromActivity:N,isActivityHighlighted:k,setActivities:I}=Ee();g.useEffect(()=>{I(t)},[t,I]),g.useEffect(()=>{const D=b=>{x(b.detail)};return window.addEventListener("autoScrollChanged",D),()=>{window.removeEventListener("autoScrollChanged",D)}},[]),g.useEffect(()=>{m&&v.current&&(v.current.scrollTop=v.current.scrollHeight)},[t,m]),Me(Ie,{onCompleted:D=>{o(D.activeUsers)}}),ye(Ke,{onData:({data:D})=>{var y;const b=(y=D==null?void 0:D.data)==null?void 0:y.userListChanged;b&&o(b)}}),ye(bs,{onData:({data:D})=>{var y,C;const b=(y=D==null?void 0:D.data)==null?void 0:y.activityAdded;b?(console.log("New activity from subscription:",b),b.type==="ROLL"&&((C=b.roll)!=null&&C.canvasData)&&(console.log("ðŸŽ² Roll activity with canvasData:",b.roll.canvasData),console.log("ðŸŽ² Dice in this roll:",b.roll.canvasData.dice)),s(E=>[b,...E])):console.log("Subscription data received, but no activityAdded field:",D==null?void 0:D.data)},onError:D=>{console.error("Error in activity subscription:",D)}});const T=D=>new Date(D).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),j=D=>{var b;return(b=n.find(y=>y.username===D))==null?void 0:b.color},P=D=>{(D.type==="ROLL"||D.type==="CHAT_MESSAGE")&&N(D.id,t)},R=D=>{if(D.type==="ROLL"&&!i||D.type==="SYSTEM_MESSAGE"&&!c||D.type==="CHAT_MESSAGE"&&!d)return null;const b=k(D.id);if(D.type==="ROLL"&&D.roll&&D.user){const y=D.roll,C=j(D.user);return r.jsx("li",{className:`p-2 rounded cursor-pointer transition-all duration-200 ${b?"bg-yellow-200 border-2 border-yellow-400 shadow-lg":"bg-brand-surface hover:bg-brand-background"}`,onClick:()=>P(D),title:"Click to highlight dice and jump camera to them",children:r.jsxs("div",{className:"flex justify-between items-start",children:[r.jsxs("div",{className:"flex-grow",children:[r.jsxs("strong",{className:`font-medium ${b?"text-black":""}`,style:{color:b?"black":C||"#ffffff",textShadow:b&&C?`0 0 2px ${C}, 0 0 4px ${C}`:"none"},children:[D.user,":"]}),r.jsxs("span",{className:`${b?"text-black":"text-brand-text"}`,children:[" Rolled ",y.expression]}),r.jsxs("span",{className:`${b?"text-black":"text-brand-text"}`,children:[" (",y.results.join(", "),") = ",y.total]})]}),r.jsx("span",{className:`text-xs ml-2 flex-shrink-0 ${b?"text-gray-700":"text-brand-text-muted"}`,children:T(D.timestamp)})]})},D.id)}if(D.type==="CHAT_MESSAGE"&&D.message&&D.user){const y=j(D.user);return r.jsx("li",{className:`p-2 rounded cursor-pointer transition-all duration-200 ${b?"bg-yellow-200 border-2 border-yellow-400 shadow-lg":"bg-brand-surface hover:bg-brand-background"}`,onClick:()=>P(D),title:"Click to toggle highlight",children:r.jsxs("div",{className:"flex justify-between items-start",children:[r.jsxs("div",{className:"flex-grow",children:[r.jsxs("strong",{className:`font-medium ${b?"text-black":""}`,style:{color:b?"black":y||"#ffffff",textShadow:b&&y?`0 0 2px ${y}, 0 0 4px ${y}`:"none"},children:[D.user,":"]}),r.jsx("span",{className:`ml-1 ${b?"text-black":"text-brand-text"}`,children:D.message})]}),r.jsx("span",{className:`text-xs ml-2 flex-shrink-0 ${b?"text-gray-700":"text-brand-text-muted"}`,children:T(D.timestamp)})]})},D.id)}return D.type==="SYSTEM_MESSAGE"&&D.message?r.jsx("li",{className:"bg-brand-background p-2 rounded border-l-2 border-brand-primary",children:r.jsxs("div",{className:"flex justify-between items-start",children:[r.jsx("div",{className:"flex-grow",children:r.jsxs("span",{className:"text-brand-text-muted italic text-sm",children:[D.user?`${D.user}: `:"",D.message]})}),r.jsx("span",{className:"text-xs text-brand-text-muted ml-2 flex-shrink-0",children:T(D.timestamp)})]})},D.id):null},V=g.useMemo(()=>t.filter(D=>!(D.type==="ROLL"&&!i||D.type==="SYSTEM_MESSAGE"&&!c||D.type==="CHAT_MESSAGE"&&!d)),[t,i,c,d]),z=g.useCallback(D=>{a&&a(D),l(!1)},[a]);return r.jsxs("div",{className:"h-full flex flex-col",children:[r.jsx("div",{className:"flex-shrink-0 mb-3",children:r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("span",{className:"text-lg",children:"ðŸ“œ"}),r.jsx("h3",{className:"text-lg font-semibold text-brand-text",children:"Activity Feed"})]})}),r.jsxs("div",{className:"flex space-x-2 mb-3 flex-shrink-0",children:[r.jsx("button",{className:`px-3 py-1 rounded text-sm transition-colors ${i?"bg-brand-primary text-white":"bg-brand-surface text-brand-text-muted hover:bg-brand-background"}`,onClick:()=>u(!i),title:"Toggle dice rolls",children:"ðŸŽ² Rolls"}),r.jsx("button",{className:`px-3 py-1 rounded text-sm transition-colors ${d?"bg-brand-primary text-white":"bg-brand-surface text-brand-text-muted hover:bg-brand-background"}`,onClick:()=>f(!d),title:"Toggle chat messages",children:"ðŸ’¬ Chat"}),r.jsx("button",{className:`px-3 py-1 rounded text-sm transition-colors ${c?"bg-brand-primary text-white":"bg-brand-surface text-brand-text-muted hover:bg-brand-background"}`,onClick:()=>h(!c),title:"Toggle system messages",children:"â„¹ï¸ System"})]}),r.jsx("div",{ref:v,className:"flex-grow min-h-0 overflow-y-auto bg-brand-surface rounded-lg p-3 mb-4",children:r.jsxs("ul",{className:"space-y-2 text-brand-text-muted",children:[V.slice().reverse().map(R),V.length===0&&r.jsx("li",{className:"text-center text-brand-text-muted py-8",children:t.length===0?"No activity yet.":"No activities match current filters."})]})}),r.jsx("div",{className:"flex-shrink-0",children:r.jsx(pt,{ref:e,hideHeader:!0,onDiceButtonClick:()=>l(!0)})}),r.jsx(Is,{isOpen:p,onClose:()=>l(!1),onQuickRoll:z})]})},Es=se.memo(Ts);class Rs{constructor(){$(this,"world",null);$(this,"materials",null);$(this,"throwRunning",!1);$(this,"defaultConfig",{gravity:new S(0,-9.82,0),solverIterations:10,allowSleep:!0,broadphase:"naive",timeStep:1/60});$(this,"stabilityThreshold",.01);$(this,"requiredStableFrames",10)}setWorld(e={}){if(this.world!==null){console.warn("DiceManager world is already initialized. Use resetWorld() to reinitialize.");return}const t={...this.defaultConfig,...e};try{this.world=new cs,this.world.gravity.copy(t.gravity),this.setBroadphase(t.broadphase),this.configureSolver(t.solverIterations),this.world.allowSleep=t.allowSleep,this.world.defaultContactMaterial.friction=.01,this.world.defaultContactMaterial.restitution=.3,this.initializeMaterials(),console.log("DiceManager: Physics world initialized successfully")}catch(s){throw this.world=null,new Error(`Failed to initialize physics world: ${s}`)}}resetWorld(e={}){this.world&&([...this.world.bodies].forEach(s=>this.world.removeBody(s)),this.world.contactmaterials.length=0),this.world=null,this.materials=null,this.throwRunning=!1,this.setWorld(e)}setBroadphase(e){if(this.world)switch(e){case"naive":this.world.broadphase=new nt;break;case"sap":this.world.broadphase=new us(this.world);break;case"grid":this.world.broadphase=new ds;break;default:console.warn(`Unknown broadphase type: ${e}, using naive`),this.world.broadphase=new nt}}configureSolver(e){this.world&&(this.world.solver.iterations=e)}initializeMaterials(){if(!this.world)throw new Error("Cannot initialize materials: physics world not set");this.materials={dice:new Le("dice"),floor:new Le("floor"),barrier:new Le("barrier")},this.setupContactMaterials()}setupContactMaterials(){if(!this.world||!this.materials)return;const e={friction:.01,restitution:.5};this.world.addContactMaterial(new _e(this.materials.floor,this.materials.dice,e));const t={friction:0,restitution:1};this.world.addContactMaterial(new _e(this.materials.barrier,this.materials.dice,t));const s={friction:0,restitution:.5};this.world.addContactMaterial(new _e(this.materials.dice,this.materials.dice,s))}step(e){if(!this.world)throw new Error("Cannot step physics: world not initialized");const t=e??this.defaultConfig.timeStep;this.world.fixedStep(t)}getWorld(){return this.world}getMaterials(){return this.materials}isInitialized(){return this.world!==null&&this.materials!==null}setGravity(e){if(!this.world)throw new Error("Cannot set gravity: world not initialized");this.world.gravity.copy(e)}getGravity(){var e;return((e=this.world)==null?void 0:e.gravity)??null}addBody(e){if(!this.world)throw new Error("Cannot add body: world not initialized");this.world.addBody(e)}removeBody(e){if(!this.world)throw new Error("Cannot remove body: world not initialized");this.world.removeBody(e)}getBodyCount(){var e;return((e=this.world)==null?void 0:e.bodies.length)??0}dispose(){this.world&&([...this.world.bodies].forEach(t=>this.world.removeBody(t)),this.world.contactmaterials.length=0),this.world=null,this.materials=null,this.throwRunning=!1,console.log("DiceManager: Physics world disposed")}async prepareValues(e,t=1e4){if(!this.world)throw new Error("Cannot roll dice: physics world not initialized");if(this.throwRunning)throw new Error("Cannot start another throw. Please wait until the current throw is finished.");for(const n of e)if(!n.dice||typeof n.value!="number")throw new Error("Invalid dice value pair: must have dice object and numeric value");this.throwRunning=!0;const s=Date.now();try{for(const n of e)n.dice.simulationRunning=!0,n.vectors=n.dice.getCurrentVectors(),n.stableCount=0;return new Promise((n,o)=>{var u;const i=()=>{var h,d;if(Date.now()-s>t){this.throwRunning=!1,(h=this.world)==null||h.removeEventListener("postStep",i),o(new Error(`Dice throw timed out after ${t}ms`));return}let c=!0;for(const f of e){const p=f.dice.isFinished();p?f.stableCount=(f.stableCount||0)+1:f.stableCount=0,(f.stableCount||0)<this.requiredStableFrames&&(c=!1),(Date.now()-s)%1e3<16&&console.log("ðŸŽ² Stability check:",{isFinished:p,stableCount:f.stableCount,requiredFrames:this.requiredStableFrames,elapsed:((Date.now()-s)/1e3).toFixed(1)+"s"})}if(c){(d=this.world)==null||d.removeEventListener("postStep",i);try{const f=[],p=(Date.now()-s)/1e3;for(const l of e){const m=l.dice.getUpperValue();l.dice.simulationRunning=!1;const x={dice:l.dice,value:m,settleDuration:p,finalPosition:l.dice.getPosition(),finalRotation:l.dice.getRotation()};f.push(x),console.log("ðŸŽ² Natural dice result:",{requestedValue:l.value,actualValue:m,position:x.finalPosition})}this.throwRunning=!1,n(f)}catch(f){this.throwRunning=!1,o(new Error(`Error processing dice results: ${f}`))}}};(u=this.world)==null||u.addEventListener("postStep",i)})}catch(n){throw this.throwRunning=!1,new Error(`Failed to start dice throw: ${n}`)}}async rollSingle(e,t,s=1e4){return(await this.prepareValues([{dice:e,value:t}],s))[0]}async rollRandom(e,t=1e4){const s=e.map(n=>({dice:n,value:Math.floor(Math.random()*n.getValueCount())+1}));return this.prepareValues(s,t)}isDiceStable(e){if(!e||!e.body)return console.log("ðŸŽ² isDiceStable: No dice or body found"),!1;const t=e.body,s=t.angularVelocity,n=t.velocity,o=Math.abs(s.x)<this.stabilityThreshold&&Math.abs(s.y)<this.stabilityThreshold&&Math.abs(s.z)<this.stabilityThreshold&&Math.abs(n.x)<this.stabilityThreshold&&Math.abs(n.y)<this.stabilityThreshold&&Math.abs(n.z)<this.stabilityThreshold,i=Math.max(Math.abs(n.x),Math.abs(n.y),Math.abs(n.z)),u=Math.max(Math.abs(s.x),Math.abs(s.y),Math.abs(s.z));return o?console.log("ðŸŽ² Dice is stable!"):Math.random()<.03&&console.log("ðŸŽ² Dice not stable yet - maxVel:",i.toFixed(4),"maxAngVel:",u.toFixed(4),"threshold:",this.stabilityThreshold),o}stopThrow(e=!1){this.throwRunning&&(e?(this.world&&this.world.removeEventListener("postStep",()=>{}),this.throwRunning=!1,console.log("DiceManager: Throw forcibly stopped")):console.warn("DiceManager: Cannot stop throw gracefully - use force=true to override"))}getThrowStatus(){return{isRunning:this.throwRunning,worldInitialized:this.isInitialized(),bodyCount:this.getBodyCount(),gravity:this.getGravity()}}}const F=new Rs;class w{static threeVectorToCannon(e){return new S(e.x,e.y,e.z)}static cannonVectorToThree(e){return new M(e.x,e.y,e.z)}static threeQuaternionToCannon(e){return new O(e.x,e.y,e.z,e.w)}static cannonQuaternionToThree(e){return new Y(e.x,e.y,e.z,e.w)}static createConvexPolyhedronFromGeometry(e){try{const t=e.attributes.position,s=[];for(let c=0;c<t.count;c++)s.push(new M().fromBufferAttribute(t,c));const n={},o=[],i=[];for(let c=0;c<s.length;c++){const h=s[c],d=`${Math.round(h.x*100)}_${Math.round(h.y*100)}_${Math.round(h.z*100)}`;n[d]===void 0?(n[d]=o.length,o.push(new S(h.x,h.y,h.z)),i[c]=o.length-1):i[c]=n[d]}const u=[];for(let c=0;c<s.length;c+=3){const h=[i[c],i[c+1],i[c+2]];h[0]!==h[1]&&h[1]!==h[2]&&h[0]!==h[2]&&u.push(h)}return new We({vertices:o,faces:u})}catch(t){throw new Error(`Failed to create ConvexPolyhedron from geometry: ${t}`)}}static createTrimeshFromGeometry(e){try{let t;e.index===null?t=e.attributes.position.array:t=e.clone().toNonIndexed().attributes.position.array;const s=Array.from({length:t.length/3},(n,o)=>o);return new hs(t,s)}catch(t){throw new Error(`Failed to create Trimesh from geometry: ${t}`)}}static createBoxShape(e,t,s){return new Ye(new S(e*.5,t*.5,s*.5))}static createSphereShape(e){return new gt(e)}static createCylinderShape(e,t,s,n=8){return new ms(e,t,s,n)}static createPlaneShape(){return new gs}static validateDiceValue(e,t,s){if(!Number.isInteger(e))throw new Error(`Dice value must be an integer, got: ${e}`);if(e<t||e>s)throw new Error(`Dice value ${e} is outside valid range [${t}, ${s}]`)}static calculateTextureSize(e){return Math.max(128,Math.pow(2,Math.ceil(Math.log2(e))))}static clamp(e,t,s){return Math.min(Math.max(e,t),s)}static randomBetween(e,t){return Math.random()*(t-e)+e}static randomIntBetween(e,t){return Math.floor(Math.random()*(t-e+1))+e}static disposeBody(e,t){try{e.removeBody(t)}catch(s){console.warn("Error disposing physics body:",s)}}static getUpwardVector(e,t=!1){const s=new S(0,t?-1:1,0);return e.vmult(s,new S)}}const xe=class xe{constructor(e,t={}){$(this,"object");$(this,"body");$(this,"options");$(this,"geometry");$(this,"simulationRunning",!1);$(this,"textureCache",new Map);if(!F.isInitialized())throw new Error("DiceManager must be initialized before creating dice objects");this.geometry=e,this.options={...xe.defaultOptions,...t},this.object=this.createMesh(),this.body=this.createBody(),this.object.userData.body=this.body,this.body.userData={object:this.object},F.addBody(this.body)}createMesh(){const e=this.createThreeGeometry(),t=this.createFaceMaterials(),s=new Lt(e,t);return s.castShadow=!0,s.receiveShadow=!0,s}createThreeGeometry(){const e=[],t=[],s=[],n=[];for(let i=0;i<this.geometry.faces.length;i++){const c=this.geometry.faces[i].map(h=>this.geometry.vertices[h]);for(let h=1;h<c.length-1;h++){const d=c[0],f=c[h],p=c[h+1],l=d.map(T=>T*this.geometry.scaleFactor*this.options.size),m=f.map(T=>T*this.geometry.scaleFactor*this.options.size),x=p.map(T=>T*this.geometry.scaleFactor*this.options.size);e.push(...l,...m,...x);const v=new M().subVectors(new M(...m),new M(...l)),N=new M().subVectors(new M(...x),new M(...l)),k=new M().crossVectors(v,N).normalize();t.push(k.x,k.y,k.z),t.push(k.x,k.y,k.z),t.push(k.x,k.y,k.z),s.push(0,0,1,0,.5,1);const I=n.length;n.push(I,I+1,I+2)}}const o=new re;return o.setAttribute("position",new Fe(e,3)),o.setAttribute("normal",new Fe(t,3)),o.setAttribute("uv",new Fe(s,2)),o.setIndex(n),o}createFaceMaterials(){const e=[];for(let t=0;t<this.geometry.faceTexts.length;t++){const s=this.geometry.faceTexts[t],n=`${s}_${this.options.fontColor}_${this.options.backColor}`;let o=this.textureCache.get(n);o||(o=this.options.customTextTextureFunction(s,this.options.fontColor.toString(),this.options.backColor.toString()),this.textureCache.set(n,o));const i=new _t({map:o,transparent:!0});e.push(i)}return e}createBody(){var s,n;let e;if(this.geometry.values===6){const o=new S(this.geometry.scaleFactor*this.options.size*.5,this.geometry.scaleFactor*this.options.size*.5,this.geometry.scaleFactor*this.options.size*.5);e=new Ye(o)}else e=this.createConvexPolyhedronShape();const t=new me({mass:this.geometry.mass,shape:e,material:(s=F.getMaterials())==null?void 0:s.dice});return t.linearDamping=.1,t.angularDamping=.1,console.log("ðŸŽ² Created physics body:",{mass:this.geometry.mass,shape:this.geometry.values===6?"Box":"ConvexPolyhedron",diceType:`D${this.geometry.values}`,material:!!((n=F.getMaterials())!=null&&n.dice)}),t}createConvexPolyhedronShape(){const t=this.geometry.vertices.map(n=>n.map(o=>o*this.geometry.scaleFactor*this.options.size)).map(n=>new S(n[0],n[1],n[2])),s=this.geometry.faces.map(n=>[...n]);try{return new We({vertices:t,faces:s})}catch(n){console.error(`Failed to create ConvexPolyhedron for D${this.geometry.values}:`,n),console.warn(`Falling back to sphere shape for D${this.geometry.values}`);const o=this.geometry.scaleFactor*this.options.size*.5;return new gt(o)}}static createTextTexture(e,t,s){if(typeof document>"u"||typeof HTMLCanvasElement>"u"){const h=new Ht(new Uint8Array(262144).fill(255),256,256,Bt);return h.needsUpdate=!0,h}const n=w.calculateTextureSize(256),o=document.createElement("canvas");o.width=n,o.height=n;const i=o.getContext("2d");i.fillStyle=s,i.fillRect(0,0,n,n),i.fillStyle=t,i.textAlign="center",i.textBaseline="middle",i.font=`bold ${n*.6}px Arial`,i.fillText(e,n/2,n/2);const u=new ct(o);return u.magFilter=Ge,u.minFilter=Ot,u.generateMipmaps=!0,u}getPosition(){return w.cannonVectorToThree(this.body.position)}setPosition(e){this.body.position.copy(w.threeVectorToCannon(e)),this.object.position.copy(e),this.body.wakeUp()}getRotation(){return w.cannonQuaternionToThree(this.body.quaternion)}setRotation(e){this.body.quaternion.copy(w.threeQuaternionToCannon(e)),this.object.quaternion.copy(e),this.body.wakeUp()}getCurrentVectors(){return{position:this.body.position.clone(),quaternion:this.body.quaternion.clone(),velocity:this.body.velocity.clone(),angularVelocity:this.body.angularVelocity.clone()}}setVectors(e){this.body.position.copy(e.position),this.body.quaternion.copy(e.quaternion),this.body.velocity.copy(e.velocity),this.body.angularVelocity.copy(e.angularVelocity),this.object.position.copy(w.cannonVectorToThree(e.position)),this.object.quaternion.copy(w.cannonQuaternionToThree(e.quaternion)),this.body.wakeUp()}isFinished(){return F.isDiceStable(this)}updateMesh(){this.object.position.copy(w.cannonVectorToThree(this.body.position)),this.object.quaternion.copy(w.cannonQuaternionToThree(this.body.quaternion))}getUpperValue(){return this.calculateUpperValue()}getValueCount(){return this.geometry.values}dispose(){F.getWorld()&&F.removeBody(this.body),this.object.geometry.dispose(),Array.isArray(this.object.material)?this.object.material.forEach(e=>{e.map&&e.map.dispose(),e.dispose()}):(this.object.material.map&&this.object.material.map.dispose(),this.object.material.dispose()),this.textureCache.forEach(e=>e.dispose()),this.textureCache.clear(),this.object.userData.body=null,this.body.userData=null}};$(xe,"defaultOptions",{size:100,fontColor:"#000000",backColor:"#ffffff",customTextTextureFunction:xe.createTextTexture});let te=xe;const le={vertices:[[-.5,0,-.289],[.5,0,-.289],[0,0,.577],[0,.816,0]],faces:[[0,1,2],[0,3,1],[1,3,2],[2,3,0]],scaleFactor:1,values:4,faceTexts:["4","1","2","3"],chamfer:.05,tab:.1,af:Math.PI/3,mass:.002,textMargin:.15,invertUpside:!0},ft={0:4,1:1,2:2,3:3},As={1:1,2:2,3:3,4:0},ne=[[0,-1,0],[0,.447,-.894],[.774,.447,.447],[-.774,.447,.447]];function Ps(){if(le.vertices.length!==4)return console.error("D4 geometry must have exactly 4 vertices"),!1;if(le.faces.length!==4)return console.error("D4 geometry must have exactly 4 faces"),!1;for(let t=0;t<le.faces.length;t++)if(le.faces[t].length!==3)return console.error(`D4 face ${t} must have exactly 3 vertices (triangular)`),!1;if(le.faceTexts.length!==4)return console.error("D4 must have exactly 4 face texts"),!1;const a=new Set(Object.values(ft)),e=new Set([1,2,3,4]);return a.size!==4||![...a].every(t=>e.has(t))?(console.error("D4 face values must be exactly [1, 2, 3, 4]"),!1):(console.log("D4 geometry validation passed"),!0)}class Re extends te{constructor(e={}){if(!Ps())throw new Error("D4 geometry validation failed");super(le,e)}calculateUpperValue(){const e=this.body.quaternion,t=new S(0,-1,0),s=e.inverse().vmult(t,new S);let n=-1/0,o=0;for(let i=0;i<ne.length;i++){const u=new S(ne[i][0],ne[i][1],ne[i][2]),c=s.dot(u);c>n&&(n=c,o=i)}return ft[o]}shiftUpperValue(e){w.validateDiceValue(e,1,4);const t=As[e];if(t===void 0)throw new Error(`Invalid D4 value: ${e}. Must be between 1 and 4.`);const s=new S(ne[t][0],ne[t][1],ne[t][2]),n=new S(0,-1,0),o=this.calculateRotationToAlignVectors(s,n);this.body.quaternion.copy(o),this.object.quaternion.copy(w.cannonQuaternionToThree(o)),this.body.velocity.set(0,0,0),this.body.angularVelocity.set(0,0,0)}calculateRotationToAlignVectors(e,t){const s=e.clone();s.normalize();const n=t.clone();n.normalize();const o=s.dot(n);if(Math.abs(o-1)<1e-6)return new O(0,0,0,1);if(Math.abs(o+1)<1e-6){let d=new S(1,0,0);Math.abs(s.x)>.9&&(d=new S(0,1,0));const f=new S;return s.cross(d,f),f.normalize(),new O(f.x,f.y,f.z,0)}const i=new S;s.cross(n,i),i.normalize();const c=Math.acos(w.clamp(o,-1,1))*.5,h=Math.sin(c);return new O(i.x*h,i.y*h,i.z*h,Math.cos(c))}getRandomRotation(){const e=w.randomBetween(0,Math.PI*2),t=w.randomBetween(0,Math.PI*2),s=w.randomBetween(0,Math.PI*2),n=new Y().setFromEuler(new Ne(e,t,s));return w.threeQuaternionToCannon(n)}throwDice(e=.8,t){const s=t||new M(w.randomBetween(-2,2),w.randomBetween(2.5,4),w.randomBetween(-2,2));this.setPosition(s),this.body.quaternion.copy(this.getRandomRotation()),this.object.quaternion.copy(w.cannonQuaternionToThree(this.body.quaternion));const n=new S(w.randomBetween(-4,4)*e,w.randomBetween(-1.5,.5)*e,w.randomBetween(-4,4)*e),o=new S(w.randomBetween(-15,15)*e,w.randomBetween(-15,15)*e,w.randomBetween(-15,15)*e);this.body.velocity.copy(n),this.body.angularVelocity.copy(o);const i=new S(w.randomBetween(-3,3),w.randomBetween(0,1.5),w.randomBetween(-3,3));this.body.velocity.vadd(i,this.body.velocity),this.simulationRunning=!0}get values(){return 4}get minValue(){return 1}get maxValue(){return 4}get diceType(){return"d4"}static createMultiple(e,t={}){const s=[];for(let n=0;n<e;n++)s.push(new Re(t));return s}}const G={vertices:[[-.5,-.5,-.5],[.5,-.5,-.5],[.5,-.5,.5],[-.5,-.5,.5],[-.5,.5,-.5],[.5,.5,-.5],[.5,.5,.5],[-.5,.5,.5]],faces:[[0,1,2,3],[7,6,5,4],[3,2,6,7],[1,0,4,5],[2,1,5,6],[0,3,7,4]],scaleFactor:1,values:6,faceTexts:["1","6","2","5","3","4"],chamfer:.1,tab:.2,af:Math.PI/4,mass:.004,textMargin:.1,invertUpside:!1},$s={0:1,1:6,2:2,3:5,4:3,5:4},Vs={1:0,2:2,3:4,4:5,5:3,6:1},oe=[[0,-1,0],[0,1,0],[0,0,1],[0,0,-1],[1,0,0],[-1,0,0]];function zs(){if(G.vertices.length!==8)return console.error("D6 geometry must have exactly 8 vertices"),!1;if(G.faces.length!==6)return console.error("D6 geometry must have exactly 6 faces"),!1;for(let i=0;i<G.faces.length;i++)if(G.faces[i].length!==4)return console.error(`D6 face ${i} must have exactly 4 vertices`),!1;if(G.faceTexts.length!==6)return console.error("D6 must have exactly 6 face texts"),!1;const a=parseInt(G.faceTexts[0]),e=parseInt(G.faceTexts[1]),t=parseInt(G.faceTexts[2]),s=parseInt(G.faceTexts[3]),n=parseInt(G.faceTexts[4]),o=parseInt(G.faceTexts[5]);return a+e!==7||t+s!==7||n+o!==7?(console.error("D6 opposite faces must sum to 7"),!1):!0}class be extends te{constructor(e={}){if(!zs())throw new Error("D6 geometry validation failed");super(G,e)}calculateUpperValue(){const e=this.body.quaternion,t=new S(0,1,0),s=e.inverse().vmult(t,new S);let n=-1/0,o=0;for(let i=0;i<oe.length;i++){const u=new S(oe[i][0],oe[i][1],oe[i][2]),c=s.dot(u);c>n&&(n=c,o=i)}return $s[o]}shiftUpperValue(e){w.validateDiceValue(e,1,6);const t=Vs[e];if(t===void 0)throw new Error(`Invalid D6 value: ${e}. Must be between 1 and 6.`);const s=new S(oe[t][0],oe[t][1],oe[t][2]),n=new S(0,1,0),o=this.calculateRotationToAlignVectors(s,n);this.body.quaternion.copy(o),this.object.quaternion.copy(w.cannonQuaternionToThree(o)),this.body.velocity.set(0,0,0),this.body.angularVelocity.set(0,0,0)}calculateRotationToAlignVectors(e,t){const s=e.clone();s.normalize();const n=t.clone();n.normalize();const o=s.dot(n);if(Math.abs(o-1)<1e-6)return new O(0,0,0,1);if(Math.abs(o+1)<1e-6){let d=new S(1,0,0);Math.abs(s.x)>.9&&(d=new S(0,1,0));const f=new S;return s.cross(d,f),f.normalize(),new O(f.x,f.y,f.z,0)}const i=new S;s.cross(n,i),i.normalize();const c=Math.acos(w.clamp(o,-1,1))*.5,h=Math.sin(c);return new O(i.x*h,i.y*h,i.z*h,Math.cos(c))}getRandomRotation(){const e=w.randomBetween(0,Math.PI*2),t=w.randomBetween(0,Math.PI*2),s=w.randomBetween(0,Math.PI*2),n=new Y().setFromEuler(new Ne(e,t,s));return w.threeQuaternionToCannon(n)}throwDice(e=1,t){const s=t||new M(w.randomBetween(-2,2),w.randomBetween(3,5),w.randomBetween(-2,2));this.setPosition(s),this.body.quaternion.copy(this.getRandomRotation()),this.object.quaternion.copy(w.cannonQuaternionToThree(this.body.quaternion));const n=new S(w.randomBetween(-5,5)*e,w.randomBetween(-2,1)*e,w.randomBetween(-5,5)*e);this.body.velocity.copy(n);const o=new S(w.randomBetween(-10,10)*e,w.randomBetween(-10,10)*e,w.randomBetween(-10,10)*e);this.body.angularVelocity.copy(o);const i=new S(w.randomBetween(-4,4),w.randomBetween(0,2),w.randomBetween(-4,4));this.body.velocity.vadd(i,this.body.velocity),this.body.wakeUp()}get values(){return 6}get minValue(){return 1}get maxValue(){return 6}get diceType(){return"d6"}static createMultiple(e,t={}){const s=[];for(let n=0;n<e;n++)s.push(new be(t));return s}}const ce={vertices:[[0,1,0],[1,0,0],[0,0,1],[-1,0,0],[0,0,-1],[0,-1,0]],faces:[[0,2,1],[0,3,2],[0,4,3],[0,1,4],[5,1,2],[5,2,3],[5,3,4],[5,4,1]],scaleFactor:1,values:8,faceTexts:["1","2","3","4","5","6","7","8"],chamfer:.08,tab:.1,af:Math.PI/3,mass:.003,textMargin:.12,invertUpside:!1},xt={0:1,1:2,2:3,3:4,4:5,5:6,6:7,7:8},Fs={1:0,2:1,3:2,4:3,5:4,6:5,7:6,8:7},J=[[.577,.577,.577],[-.577,.577,.577],[-.577,.577,-.577],[.577,.577,-.577],[.577,-.577,.577],[-.577,-.577,.577],[-.577,-.577,-.577],[.577,-.577,-.577]];function Us(){if(ce.vertices.length!==6)return console.error("D8 geometry must have exactly 6 vertices"),!1;if(ce.faces.length!==8)return console.error("D8 geometry must have exactly 8 faces"),!1;for(let t=0;t<ce.faces.length;t++)if(ce.faces[t].length!==3)return console.error(`D8 face ${t} must have exactly 3 vertices (triangular)`),!1;if(ce.faceTexts.length!==8)return console.error("D8 must have exactly 8 face texts"),!1;const a=new Set(Object.values(xt)),e=new Set([1,2,3,4,5,6,7,8]);return a.size!==8||![...a].every(t=>e.has(t))?(console.error("D8 face values must be exactly [1, 2, 3, 4, 5, 6, 7, 8]"),!1):J.length!==8?(console.error("D8 must have exactly 8 face normals"),!1):(console.log("D8 geometry validation passed"),!0)}class Ae extends te{constructor(e={}){if(!Us())throw new Error("D8 geometry validation failed");super(ce,e)}calculateUpperValue(){const e=this.body.quaternion,t=new S(0,1,0),s=e.inverse().vmult(t,new S);let n=-1/0,o=0;for(let i=0;i<J.length;i++){const u=new S(J[i][0],J[i][1],J[i][2]),c=s.dot(u);c>n&&(n=c,o=i)}return xt[o]}shiftUpperValue(e){w.validateDiceValue(e,1,8);const t=Fs[e];if(t===void 0)throw new Error(`Invalid D8 value: ${e}. Must be between 1 and 8.`);const s=new S(J[t][0],J[t][1],J[t][2]),n=new S(0,1,0),o=this.calculateRotationToAlignVectors(s,n);this.body.quaternion.copy(o),this.object.quaternion.copy(w.cannonQuaternionToThree(o)),this.body.velocity.set(0,0,0),this.body.angularVelocity.set(0,0,0)}calculateRotationToAlignVectors(e,t){const s=e.clone();s.normalize();const n=t.clone();n.normalize();const o=s.dot(n);if(Math.abs(o-1)<1e-6)return new O(0,0,0,1);if(Math.abs(o+1)<1e-6){let d=new S(1,0,0);Math.abs(s.x)>.9&&(d=new S(0,1,0));const f=new S;return s.cross(d,f),f.normalize(),new O(f.x,f.y,f.z,0)}const i=new S;s.cross(n,i),i.normalize();const c=Math.acos(w.clamp(o,-1,1))*.5,h=Math.sin(c);return new O(i.x*h,i.y*h,i.z*h,Math.cos(c))}getRandomRotation(){const e=w.randomBetween(0,Math.PI*2),t=w.randomBetween(0,Math.PI*2),s=w.randomBetween(0,Math.PI*2),n=new Y().setFromEuler(new Ne(e,t,s));return w.threeQuaternionToCannon(n)}throwDice(e=1,t){const s=t||new M(w.randomBetween(-2.2,2.2),w.randomBetween(3.5,5.5),w.randomBetween(-2.2,2.2));this.setPosition(s),this.body.quaternion.copy(this.getRandomRotation()),this.updateMesh();const n=w.randomBetween(-8,8)*e,o=w.randomBetween(2,6)*e,i=w.randomBetween(-8,8)*e,u=w.randomBetween(-15,15)*e,c=w.randomBetween(-15,15)*e,h=w.randomBetween(-15,15)*e;this.body.velocity.set(n,o,i),this.body.angularVelocity.set(u,c,h);const d=new S(w.randomBetween(-4,4),w.randomBetween(0,2),w.randomBetween(-4,4));this.body.velocity.vadd(d,this.body.velocity),this.body.wakeUp(),console.log(`ðŸŽ² D8 thrown with force: [${n.toFixed(2)}, ${o.toFixed(2)}, ${i.toFixed(2)}], angular: [${u.toFixed(2)}, ${c.toFixed(2)}, ${h.toFixed(2)}]`)}get values(){return 8}get minValue(){return 1}get maxValue(){return 8}get diceType(){return"d8"}static createMultiple(e,t={}){const s=[];for(let n=0;n<e;n++)s.push(new Ae(t));return s}}function Ls(){const a=[];for(let e=0;e<10;e++){const t=Math.PI*2/10*e,s=Math.cos(t),n=Math.sin(t),o=.105*(e%2?1:-1);a.push([s,n,o])}return a.push([0,0,-1]),a.push([0,0,1]),a}const B={vertices:Ls(),faces:[[5,7,11,0],[4,2,10,1],[1,3,11,2],[0,8,10,3],[7,9,11,4],[8,6,10,5],[9,1,11,6],[2,0,10,7],[3,5,11,8],[6,4,10,9],[1,0,2],[1,2,3],[3,2,4],[3,4,5],[5,4,6],[5,6,7],[7,6,8],[7,8,9],[9,8,0],[9,0,1]],scaleFactor:.9,values:10,faceTexts:["1","2","3","4","5","6","7","8","9","10","","","","","","","","","",""],chamfer:.945,tab:0,af:Math.PI*6/5,mass:.35,textMargin:1,invertUpside:!1},yt={0:1,1:2,2:3,3:4,4:5,5:6,6:7,7:8,8:9,9:10,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0},Ce=[[.688,.5,.526],[-.162,-.5,-.851],[-.526,.851,0],[-.688,-.5,-.526],[.526,.851,0],[-.688,.5,-.526],[.162,.5,.851],[.162,-.5,-.851],[.688,-.5,.526],[-.162,.5,-.851],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]];function _s(){if(B.vertices.length!==12)return console.error("D10 geometry must have exactly 12 vertices"),!1;if(B.faces.length!==20)return console.error("D10 geometry must have exactly 20 faces"),!1;for(let t=0;t<10;t++)if(B.faces[t].length!==4)return console.error(`D10 kite face ${t} must have exactly 4 vertices`),!1;for(let t=10;t<20;t++)if(B.faces[t].length!==3)return console.error(`D10 triangular face ${t} must have exactly 3 vertices`),!1;if(B.faceTexts.length!==20)return console.error("D10 must have exactly 20 face texts"),!1;const a=Object.values(yt).filter(t=>t>0),e=new Set(Array.from({length:10},(t,s)=>s+1));if(a.length!==10||!a.every(t=>e.has(t)))return console.error("D10 kite face values must be exactly [1, 2, 3, ..., 10]"),!1;if(Ce.length!==20)return console.error("D10 must have exactly 20 face normals"),!1;for(let t=0;t<10;t++){const s=B.vertices[t],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]);if(Math.abs(n-1)>1e-6)return console.error(`D10 circumference vertex ${t} should be at unit distance from origin in XY plane`),!1}return console.log("D10 geometry validation passed"),!0}class bt extends te{constructor(t={}){if(!_s())throw new Error("D10 geometry validation failed");super(B,{size:1,...t});$(this,"diceType","d10");console.log("ðŸŽ² Creating D10 dice with options:",this.options)}createGeometry(){var f;console.log("ðŸŽ² Creating D10 geometry...");const t=new re,s=this.options.size,n=B.scaleFactor,o=B.vertices,i=B.faces;console.log("ðŸŽ² D10 geometry data:",{vertexCount:o.length,faceCount:i.length,scaleFactor:n,size:s});const u=[];for(let p=0;p<i.length;p++){const l=i[p];l.length===4?(u.push([l[0],l[1],l[2]]),u.push([l[0],l[2],l[3]])):l.length===3?u.push([l[0],l[1],l[2]]):console.warn(`ðŸŽ² D10 face ${p} has unexpected vertex count: ${l.length}`)}console.log("ðŸŽ² D10 triangulated faces:",u.length);const c=new Float32Array(u.length*9),h=new Float32Array(u.length*9),d=new Float32Array(u.length*6);for(let p=0;p<u.length;p++){const l=u[p],m=p*9,x=p*6,v=new M(o[l[0]][0]*s*n,o[l[0]][1]*s*n,o[l[0]][2]*s*n),N=new M(o[l[1]][0]*s*n,o[l[1]][1]*s*n,o[l[1]][2]*s*n),k=new M(o[l[2]][0]*s*n,o[l[2]][1]*s*n,o[l[2]][2]*s*n);c[m]=v.x,c[m+1]=v.y,c[m+2]=v.z,c[m+3]=N.x,c[m+4]=N.y,c[m+5]=N.z,c[m+6]=k.x,c[m+7]=k.y,c[m+8]=k.z;const I=new M().crossVectors(N.clone().sub(v),k.clone().sub(v)).normalize();h[m]=I.x,h[m+1]=I.y,h[m+2]=I.z,h[m+3]=I.x,h[m+4]=I.y,h[m+5]=I.z,h[m+6]=I.x,h[m+7]=I.y,h[m+8]=I.z,d[x]=0,d[x+1]=0,d[x+2]=1,d[x+3]=0,d[x+4]=.5,d[x+5]=1}return t.setAttribute("position",new U(c,3)),t.setAttribute("normal",new U(h,3)),t.setAttribute("uv",new U(d,2)),t.computeBoundingSphere(),console.log("ðŸŽ² D10 geometry created:",{triangles:u.length,vertices:c.length/3,boundingSphere:(f=t.boundingSphere)==null?void 0:f.radius}),t}createPhysicsShape(){console.log("ðŸŽ² Creating D10 physics shape...");const t=B.vertices,s=B.faces,n=this.options.size,o=B.scaleFactor,i=t.map(h=>new S(h[0]*n*o,h[1]*n*o,h[2]*n*o)),u=s.map(h=>[...h]);console.log("ðŸŽ² D10 physics shape data:",{vertices:i.length,faces:u.length,scaleFactor:o,size:n});const c=new We({vertices:i,faces:u});return console.log("ðŸŽ² D10 ConvexPolyhedron created"),c}calculateUpperValue(){if(!this.body)return console.warn("ðŸŽ² D10 body not available for value reading"),1;const t=new M(0,1,0);let s=0,n=Math.PI;for(let i=0;i<10;i++){const u=new M(Ce[i][0],Ce[i][1],Ce[i][2]);u.applyQuaternion(new Y(this.body.quaternion.x,this.body.quaternion.y,this.body.quaternion.z,this.body.quaternion.w));const c=u.angleTo(t);c<n&&(n=c,s=i)}const o=yt[s]||1;return console.log("ðŸŽ² D10 face reading:",{faceIndex:s,value:o,angle:(n*180/Math.PI).toFixed(1)+"Â°"}),o}shiftUpperValue(t){if(!this.body){console.warn("ðŸŽ² Cannot shift D10 value - no physics body");return}if(t<1||t>10){console.warn("ðŸŽ² D10 target value must be between 1 and 10");return}console.log("ðŸŽ² Shifting D10 to show value:",t),this.body.quaternion.set(0,0,0,1);const s=(t-1)*Math.PI*2/10;this.body.quaternion.setFromAxisAngle(new S(0,1,0),s),console.log("ðŸŽ² D10 shifted to target value:",t)}getUpsideValue(){return this.calculateUpperValue()}throwDice(t=1){if(!this.body){console.warn("ðŸŽ² Cannot throw D10 - no physics body");return}console.log("ðŸŽ² Throwing D10 with force:",t);const s=t*8,n=new M((Math.random()-.5)*2,Math.random()*.5+.3,(Math.random()-.5)*2).normalize();this.body.velocity.set(n.x*s,n.y*s,n.z*s),this.body.angularVelocity.set((Math.random()-.5)*20,(Math.random()-.5)*20,(Math.random()-.5)*20);const o=new S(w.randomBetween(-4.5,4.5),w.randomBetween(0,2.5),w.randomBetween(-4.5,4.5));this.body.velocity.vadd(o,this.body.velocity),this.body.wakeUp(),console.log("ðŸŽ² D10 thrown:",{velocity:this.body.velocity,angularVelocity:this.body.angularVelocity})}}const _=(1+Math.sqrt(5))/2,q=1/_,de={vertices:[[0,q,_],[0,q,-_],[0,-q,_],[0,-q,-_],[_,0,q],[_,0,-q],[-_,0,q],[-_,0,-q],[q,_,0],[q,-_,0],[-q,_,0],[-q,-_,0],[1,1,1],[1,1,-1],[1,-1,1],[1,-1,-1],[-1,1,1],[-1,1,-1],[-1,-1,1],[-1,-1,-1]],faces:[[2,14,4,12,0],[15,9,11,19,3],[16,10,17,7,6],[6,7,19,11,18],[6,18,2,0,16],[18,11,9,14,2],[1,17,10,8,13],[1,13,5,15,3],[13,8,12,4,5],[5,4,14,9,15],[0,12,8,10,16],[3,19,7,17,1]],scaleFactor:.75,values:12,faceTexts:["1","2","3","4","5","6","7","8","9","10","11","12"],chamfer:.968,tab:.2,af:-Math.PI/4/2,mass:.35,textMargin:1,invertUpside:!1},wt={0:1,1:2,2:3,3:4,4:5,5:6,6:7,7:8,8:9,9:10,10:11,11:12},Hs={1:0,2:1,3:2,4:3,5:4,6:5,7:6,8:7,9:8,10:9,11:10,12:11},je=[[.525,0,.851],[0,-.851,-.525],[-.851,.525,0],[-.525,-.309,.794],[-.525,.309,.794],[0,-.851,.525],[0,.851,-.525],[.525,0,-.851],[.851,.525,0],[.525,-.309,-.794],[0,.851,.525],[-.525,0,-.851]];function Bs(){if(de.vertices.length!==20)return console.error("D12 geometry must have exactly 20 vertices"),!1;if(de.faces.length!==12)return console.error("D12 geometry must have exactly 12 faces"),!1;for(let s=0;s<de.faces.length;s++)if(de.faces[s].length!==5)return console.error(`D12 face ${s} must have exactly 5 vertices (pentagonal)`),!1;if(de.faceTexts.length!==12)return console.error("D12 must have exactly 12 face texts"),!1;const a=new Set(Object.values(wt)),e=new Set(Array.from({length:12},(s,n)=>n+1));if(a.size!==12||!Array.from(a).every(s=>e.has(s)))return console.error("D12 face values must be exactly [1, 2, 3, ..., 12]"),!1;if(je.length!==12)return console.error("D12 must have exactly 12 face normals"),!1;const t=(1+Math.sqrt(5))/2;return Math.abs(_-t)>1e-6?(console.error("D12 golden ratio calculation is incorrect"),!1):(console.log("D12 geometry validation passed"),!0)}class vt extends te{constructor(t){if(!Bs())throw new Error("D12 geometry validation failed");super(de,t);$(this,"diceType","d12");console.log("ðŸŽ² D12 (Dodecahedron) created with options:",{size:t.size,vertices:this.geometry.vertices.length,faces:this.geometry.faces.length,mass:this.geometry.mass,scaleFactor:this.geometry.scaleFactor})}calculateUpperValue(){return this.getUpsideValue()}getUpsideValue(){if(!this.body)return console.warn("D12: Cannot determine upside value - no physics body"),1;const t=this.body.quaternion,s=new M(0,1,0);let n=-1/0,o=0;for(let u=0;u<je.length;u++){const h=new M(...je[u]).clone();h.applyQuaternion(t);const d=h.dot(s);d>n&&(n=d,o=u)}const i=wt[o];return i<1||i>12?(console.warn(`D12: Invalid face value ${i} for face ${o}, defaulting to 1`),1):i}shiftUpperValue(t){if(!this.body){console.warn("D12: Cannot shift value - no physics body");return}if(t<1||t>12){console.warn(`D12: Invalid value ${t}, must be between 1 and 12`);return}const s=Hs[t];if(s===void 0){console.warn(`D12: No face mapping found for value ${t}`);return}const n=new M(...je[s]),o=new M(0,1,0),i=new Y;i.setFromUnitVectors(n,o),this.body.quaternion.set(i.x,i.y,i.z,i.w),this.object&&this.object.quaternion.copy(i),this.body.angularVelocity.set(0,0,0),this.body.wakeUp(),console.log(`ðŸŽ² D12 positioned to show value ${t} (face ${s})`)}getRandomValue(){return Math.floor(Math.random()*12)+1}isValidValue(t){return Number.isInteger(t)&&t>=1&&t<=12}getDiceInfo(){return{type:"D12",sides:12,shape:"Dodecahedron",description:"Twelve-sided die with pentagonal faces",minValue:1,maxValue:12,vertices:20,faces:12,faceShape:"Pentagon",geometry:this.geometry,currentValue:this.getUpsideValue()}}throwDice(t=1.1,s){if(!this.body){console.warn("D12: Cannot throw dice - no physics body");return}s&&this.body.position.set(s.x,s.y,s.z);const n=t*4,o=new M((Math.random()-.5)*n,Math.random()*n*.6+n*.2,(Math.random()-.5)*n),i=t*10,u=new M((Math.random()-.5)*i,(Math.random()-.5)*i,(Math.random()-.5)*i);this.body.velocity.set(o.x,o.y,o.z),this.body.angularVelocity.set(u.x,u.y,u.z);const c=new S(w.randomBetween(-5,5),w.randomBetween(0,3),w.randomBetween(-5,5));this.body.velocity.vadd(c,this.body.velocity),this.body.wakeUp(),console.log("ðŸŽ² D12 thrown with force:",{throwForce:t,velocity:o,angularVelocity:u,position:s||this.getPosition()})}toString(){const t=this.getUpsideValue(),s=this.getPosition();return`D12(value: ${t}, position: [${s.x.toFixed(2)}, ${s.y.toFixed(2)}, ${s.z.toFixed(2)}])`}}const H=(1+Math.sqrt(5))/2,ue={vertices:[[-1,H,0],[1,H,0],[-1,-H,0],[1,-H,0],[0,-1,H],[0,1,H],[0,-1,-H],[0,1,-H],[H,0,-1],[H,0,1],[-H,0,-1],[-H,0,1]],faces:[[0,11,5],[0,5,1],[0,1,7],[0,7,10],[0,10,11],[1,5,9],[5,11,4],[11,10,2],[10,7,6],[7,1,8],[3,9,4],[3,4,2],[3,2,6],[3,6,8],[3,8,9],[4,9,5],[2,4,11],[6,2,10],[8,6,7],[9,8,1]],scaleFactor:.6,values:20,faceTexts:["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20"],chamfer:.06,tab:.08,af:Math.PI/3,mass:.005,textMargin:.1,invertUpside:!1},Dt={0:1,1:2,2:3,3:4,4:5,5:6,6:7,7:8,8:9,9:10,10:11,11:12,12:13,13:14,14:15,15:16,16:17,17:18,18:19,19:20},Os={1:0,2:1,3:2,4:3,5:4,6:5,7:6,8:7,9:8,10:9,11:10,12:11,13:12,14:13,15:14,16:15,17:16,18:17,19:18,20:19},ee=[[-.357,.934,0],[0,.934,.357],[.577,.577,-.577],[-.577,.577,-.577],[-.577,.577,.577],[.577,.577,.577],[-0,.357,.934],[-.934,.357,0],[-.577,.577,-.577],[.934,.357,-0],[.934,-.357,0],[-0,-.357,.934],[-.934,-.357,0],[0,-.357,-.934],[.934,-.357,0],[0,-.934,.357],[-.577,-.577,.577],[-.577,-.577,-.577],[.577,-.577,-.577],[.577,-.577,.577]];function qs(){if(ue.vertices.length!==12)return console.error("D20 geometry must have exactly 12 vertices"),!1;if(ue.faces.length!==20)return console.error("D20 geometry must have exactly 20 faces"),!1;for(let s=0;s<ue.faces.length;s++)if(ue.faces[s].length!==3)return console.error(`D20 face ${s} must have exactly 3 vertices (triangular)`),!1;if(ue.faceTexts.length!==20)return console.error("D20 must have exactly 20 face texts"),!1;const a=new Set(Object.values(Dt)),e=new Set(Array.from({length:20},(s,n)=>n+1));if(a.size!==20||![...a].every(s=>e.has(s)))return console.error("D20 face values must be exactly [1, 2, 3, ..., 20]"),!1;if(ee.length!==20)return console.error("D20 must have exactly 20 face normals"),!1;const t=(1+Math.sqrt(5))/2;return Math.abs(H-t)>1e-6?(console.error("D20 golden ratio calculation is incorrect"),!1):(console.log("D20 geometry validation passed"),!0)}class Pe extends te{constructor(e={}){if(!qs())throw new Error("D20 geometry validation failed");super(ue,e)}calculateUpperValue(){const e=this.body.quaternion,t=new S(0,1,0),s=e.inverse().vmult(t,new S);let n=-1/0,o=0;for(let i=0;i<ee.length;i++){const u=new S(ee[i][0],ee[i][1],ee[i][2]),c=s.dot(u);c>n&&(n=c,o=i)}return Dt[o]}shiftUpperValue(e){w.validateDiceValue(e,1,20);const t=Os[e];if(t===void 0)throw new Error(`Invalid D20 value: ${e}. Must be between 1 and 20.`);const s=new S(ee[t][0],ee[t][1],ee[t][2]),n=new S(0,1,0),o=this.calculateRotationToAlignVectors(s,n);this.body.quaternion.copy(o),this.object.quaternion.copy(w.cannonQuaternionToThree(o)),this.body.velocity.set(0,0,0),this.body.angularVelocity.set(0,0,0)}calculateRotationToAlignVectors(e,t){const s=e.clone();s.normalize();const n=t.clone();n.normalize();const o=s.dot(n);if(Math.abs(o-1)<1e-6)return new O(0,0,0,1);if(Math.abs(o+1)<1e-6){let d=new S(1,0,0);Math.abs(s.x)>.9&&(d=new S(0,1,0));const f=new S;return s.cross(d,f),f.normalize(),new O(f.x,f.y,f.z,0)}const i=new S;s.cross(n,i),i.normalize();const c=Math.acos(w.clamp(o,-1,1))*.5,h=Math.sin(c);return new O(i.x*h,i.y*h,i.z*h,Math.cos(c))}getRandomRotation(){const e=w.randomBetween(0,Math.PI*2),t=w.randomBetween(0,Math.PI*2),s=w.randomBetween(0,Math.PI*2),n=new Y().setFromEuler(new Ne(e,t,s));return w.threeQuaternionToCannon(n)}throwDice(e=1.2,t){const s=t||new M(w.randomBetween(-2.5,2.5),w.randomBetween(4,6),w.randomBetween(-2.5,2.5));this.setPosition(s),this.body.quaternion.copy(this.getRandomRotation()),this.updateMesh();const n=w.randomBetween(-10,10)*e,o=w.randomBetween(3,8)*e,i=w.randomBetween(-10,10)*e,u=w.randomBetween(-20,20)*e,c=w.randomBetween(-20,20)*e,h=w.randomBetween(-20,20)*e;this.body.velocity.set(n,o,i),this.body.angularVelocity.set(u,c,h);const d=new S(w.randomBetween(-5,5),w.randomBetween(0,3),w.randomBetween(-5,5));this.body.velocity.vadd(d,this.body.velocity),this.body.wakeUp(),console.log(`ðŸŽ² D20 thrown with force: [${n.toFixed(2)}, ${o.toFixed(2)}, ${i.toFixed(2)}], angular: [${u.toFixed(2)}, ${c.toFixed(2)}, ${h.toFixed(2)}]`)}get values(){return 20}get minValue(){return 1}get maxValue(){return 20}get diceType(){return"d20"}static createMultiple(e,t={}){const s=[];for(let n=0;n<e;n++)s.push(new Pe(t));return s}}const Ct=({color:a,isHovered:e=!1,isHighlighted:t=!1,roughness:s,metalness:n,baseEmissiveIntensity:o=.1,pulseSpeed:i=2,pulseIntensity:u=.4})=>{const c=g.useRef(null);ke(l=>{if(c.current&&t){const m=l.clock.getElapsedTime(),x=Math.sin(m*i)*.5+.5;c.current.emissiveIntensity=o+x*u}});const h=s??(e?.1:.3),d=n??(e?.3:.1);let f="#000000",p=0;return t?(f=a,p=o):e&&(f=a,p=.1),r.jsx("meshStandardMaterial",{ref:c,color:a,roughness:h,metalness:d,emissive:f,emissiveIntensity:p})},ge=({color:a,isHovered:e=!1,isHighlighted:t=!1,onPointerDown:s,onPointerMove:n,onPointerUp:o,onPointerEnter:i,onPointerLeave:u,meshRef:c,geometry:h,children:d})=>r.jsx("mesh",{ref:c,geometry:h||void 0,castShadow:!0,receiveShadow:!0,onPointerDown:s,onPointerMove:n,onPointerUp:o,onPointerEnter:i,onPointerLeave:u,children:d||r.jsx(Ct,{color:a,isHovered:e,isHighlighted:t})}),$e=a=>{const e=new Float32Array(a.length);for(let t=0;t<a.length;t+=9){const s=new M(a[t],a[t+1],a[t+2]),n=new M(a[t+3],a[t+4],a[t+5]),o=new M(a[t+6],a[t+7],a[t+8]),i=new M().crossVectors(n.clone().sub(s),o.clone().sub(s)).normalize();e[t]=i.x,e[t+1]=i.y,e[t+2]=i.z,e[t+3]=i.x,e[t+4]=i.y,e[t+5]=i.z,e[t+6]=i.x,e[t+7]=i.y,e[t+8]=i.z}return e},ve=a=>{const e=new Float32Array(a*6);for(let t=0;t<a;t++){const s=t*6;e[s]=0,e[s+1]=0,e[s+2]=1,e[s+3]=0,e[s+4]=.5,e[s+5]=1}return e},jt=a=>{const{size:e}=a,t=se.useMemo(()=>{const s=new re,n=new Float32Array([-.5*e,0*e,-.289*e,.5*e,0*e,-.289*e,0*e,0*e,.577*e,-.5*e,0*e,-.289*e,0*e,.816*e,0*e,.5*e,0*e,-.289*e,.5*e,0*e,-.289*e,0*e,.816*e,0*e,0*e,0*e,.577*e,0*e,0*e,.577*e,0*e,.816*e,0*e,-.5*e,0*e,-.289*e]),o=$e(n),i=ve(4);return s.setAttribute("position",new U(n,3)),s.setAttribute("normal",new U(o,3)),s.setAttribute("uv",new U(i,2)),s},[e]);return r.jsx(ge,{...a,geometry:t})};jt.diceType="d4";const St=a=>r.jsxs(ge,{...a,children:[r.jsx("boxGeometry",{args:[1,1,1]}),r.jsx(Ct,{color:a.color,isHovered:a.isHovered,isHighlighted:a.isHighlighted})]});St.diceType="d6";const Nt=a=>{const{size:e}=a,t=se.useMemo(()=>{const s=new re,n=[[0,1,0],[1,0,0],[0,0,1],[-1,0,0],[0,0,-1],[0,-1,0]],o=[[0,2,1],[0,3,2],[0,4,3],[0,1,4],[5,1,2],[5,2,3],[5,3,4],[5,4,1]],i=new Float32Array(o.length*9);for(let h=0;h<o.length;h++){const d=o[h];for(let f=0;f<3;f++){const p=n[d[f]],l=h*9+f*3;i[l]=p[0]*e,i[l+1]=p[1]*e,i[l+2]=p[2]*e}}const u=$e(i),c=ve(8);return s.setAttribute("position",new U(i,3)),s.setAttribute("normal",new U(u,3)),s.setAttribute("uv",new U(c,2)),s},[e]);return r.jsx(ge,{...a,geometry:t})};Nt.diceType="d8";const kt=a=>{const{size:e}=a,t=se.useMemo(()=>{const s=new re,n=[];for(let p=0;p<10;p++){const l=Math.PI*2/10*p,m=Math.cos(l),x=Math.sin(l),v=.105*(p%2?1:-1);n.push([m,x,v])}n.push([0,0,-1]),n.push([0,0,1]);const o=[[5,7,11,0],[4,2,10,1],[1,3,11,2],[0,8,10,3],[7,9,11,4],[8,6,10,5],[9,1,11,6],[2,0,10,7],[3,5,11,8],[6,4,10,9],[1,0,2],[1,2,3],[3,2,4],[3,4,5],[5,4,6],[5,6,7],[7,6,8],[7,8,9],[9,8,0],[9,0,1]],i=[],u=[];for(let p=0;p<o.length;p++){const l=o[p];l.length===4?(i.push([l[0],l[1],l[2]]),i.push([l[0],l[2],l[3]]),u.push(p),u.push(p)):l.length===3&&(i.push([l[0],l[1],l[2]]),u.push(p))}const c=[];for(let p=0;p<o.length;p++){const l=o[p],m=new M(n[l[0]][0]*e*.9,n[l[0]][1]*e*.9,n[l[0]][2]*e*.9),x=new M(n[l[1]][0]*e*.9,n[l[1]][1]*e*.9,n[l[1]][2]*e*.9),v=new M(n[l[2]][0]*e*.9,n[l[2]][1]*e*.9,n[l[2]][2]*e*.9),N=new M().crossVectors(x.clone().sub(m),v.clone().sub(m)).normalize();c.push(N)}const h=new Float32Array(i.length*9);for(let p=0;p<i.length;p++){const l=i[p];for(let m=0;m<3;m++){const x=n[l[m]],v=p*9+m*3;h[v]=x[0]*e*.9,h[v+1]=x[1]*e*.9,h[v+2]=x[2]*e*.9}}const d=new Float32Array(h.length);for(let p=0;p<i.length;p++){const l=u[p],m=c[l],x=p*9;d[x]=m.x,d[x+1]=m.y,d[x+2]=m.z,d[x+3]=m.x,d[x+4]=m.y,d[x+5]=m.z,d[x+6]=m.x,d[x+7]=m.y,d[x+8]=m.z}const f=ve(i.length);return s.setAttribute("position",new U(h,3)),s.setAttribute("normal",new U(d,3)),s.setAttribute("uv",new U(f,2)),s},[e]);return r.jsx(ge,{...a,geometry:t})};kt.diceType="d10";const Mt=a=>{const{size:e}=a,t=se.useMemo(()=>{const s=new re,n=(1+Math.sqrt(5))/2,o=1/n,i=[[0,o,n],[0,o,-n],[0,-o,n],[0,-o,-n],[n,0,o],[n,0,-o],[-n,0,o],[-n,0,-o],[o,n,0],[o,-n,0],[-o,n,0],[-o,-n,0],[1,1,1],[1,1,-1],[1,-1,1],[1,-1,-1],[-1,1,1],[-1,1,-1],[-1,-1,1],[-1,-1,-1]],u=[[2,14,4,12,0],[15,9,11,19,3],[16,10,17,7,6],[6,7,19,11,18],[6,18,2,0,16],[18,11,9,14,2],[1,17,10,8,13],[1,13,5,15,3],[13,8,12,4,5],[5,4,14,9,15],[0,12,8,10,16],[3,19,7,17,1]],c=[];for(const p of u)c.push([p[0],p[1],p[2]]),c.push([p[0],p[2],p[3]]),c.push([p[0],p[3],p[4]]);const h=new Float32Array(c.length*9);for(let p=0;p<c.length;p++){const l=c[p];for(let m=0;m<3;m++){const x=i[l[m]],v=p*9+m*3;h[v]=x[0]*e*.75,h[v+1]=x[1]*e*.75,h[v+2]=x[2]*e*.75}}const d=$e(h),f=ve(c.length);return s.setAttribute("position",new U(h,3)),s.setAttribute("normal",new U(d,3)),s.setAttribute("uv",new U(f,2)),s},[e]);return r.jsx(ge,{...a,geometry:t})};Mt.diceType="d12";const It=a=>{const{size:e}=a,t=se.useMemo(()=>{const s=new re,n=(1+Math.sqrt(5))/2,o=[[-1,n,0],[1,n,0],[-1,-n,0],[1,-n,0],[0,-1,n],[0,1,n],[0,-1,-n],[0,1,-n],[n,0,-1],[n,0,1],[-n,0,-1],[-n,0,1]],i=[[0,11,5],[0,5,1],[0,1,7],[0,7,10],[0,10,11],[1,5,9],[5,11,4],[11,10,2],[10,7,6],[7,1,8],[3,9,4],[3,4,2],[3,2,6],[3,6,8],[3,8,9],[4,9,5],[2,4,11],[6,2,10],[8,6,7],[9,8,1]],u=new Float32Array(i.length*9);for(let d=0;d<i.length;d++){const f=i[d];for(let p=0;p<3;p++){const l=o[f[p]],m=d*9+p*3;u[m]=l[0]*e*.6,u[m+1]=l[1]*e*.6,u[m+2]=l[2]*e*.6}}const c=$e(u),h=ve(i.length);return s.setAttribute("position",new U(u,3)),s.setAttribute("normal",new U(c,3)),s.setAttribute("uv",new U(h,2)),s},[e]);return r.jsx(ge,{...a,geometry:t})};It.diceType="d20";const Gs={d4:jt,d6:St,d8:Nt,d10:kt,d12:Mt,d20:It},Qs=({onInitialized:a,children:e})=>{const[t,s]=g.useState(!1),n=g.useRef(null);return g.useEffect(()=>{(async()=>{try{if(!F.isInitialized()){console.log("ðŸŽ² Initializing physics world..."),F.setWorld();const i=F.getWorld();i&&(i.defaultContactMaterial.friction=.4,i.defaultContactMaterial.restitution=.3,i.addEventListener("addBody",u=>{const c=u.body;c&&(c.linearDamping=.1,c.angularDamping=.1)})),console.log("ðŸŽ² Physics world initialized successfully")}s(!0),a==null||a(!0)}catch(i){console.error("âŒ Failed to initialize physics:",i),a==null||a(!1)}})()},[]),g.useEffect(()=>{const o=F.getWorld();if(n.current=o,!o)return;const i=u=>{console.log("ðŸŒ Body added to physics world:",u.body.id)};return o.addEventListener("addBody",i),()=>{o.removeEventListener("addBody",i)}},[]),ke((o,i)=>{t&&F.isInitialized()&&F.step(i)}),t?r.jsx(r.Fragment,{children:e}):null},Ws=({tableSize:a=80,wallHeight:e=20,wallThickness:t=1})=>{g.useEffect(()=>{const n=w.createPlaneShape(),o=new me({mass:0});o.addShape(n),o.quaternion.setFromAxisAngle(new S(1,0,0),-Math.PI/2),o.position.set(0,-1,0),F.getMaterials()&&(o.material=F.getMaterials().floor),F.addBody(o);const i=[{pos:[0,e/2-1,-a/2],size:[a,e,t]},{pos:[0,e/2-1,a/2],size:[a,e,t]},{pos:[a/2,e/2-1,0],size:[t,e,a]},{pos:[-a/2,e/2-1,0],size:[t,e,a]}],u=[];return i.forEach(c=>{const h=new Ye(new S(c.size[0]/2,c.size[1]/2,c.size[2]/2)),d=new me({mass:0});d.addShape(h),d.position.set(c.pos[0],c.pos[1],c.pos[2]),F.getMaterials()&&(d.material=F.getMaterials().floor),F.addBody(d),u.push(d)}),console.log("ðŸŽ² Enhanced large sandbox created:",{ground:"Y: -1",walls:u.length,tableSize:a,wallHeight:e}),()=>{F.removeBody(o),u.forEach(c=>F.removeBody(c))}},[a,e,t]);const s=se.useMemo(()=>{const n=document.createElement("canvas");n.width=320,n.height=320;const o=n.getContext("2d");o.fillStyle="#1a1f2c",o.fillRect(0,0,320,320);const i=64,u=i*5;o.imageSmoothingEnabled=!0,o.strokeStyle="#cccccc",o.lineWidth=2,o.globalAlpha=.4;for(let d=i;d<320;d+=i)o.beginPath(),o.moveTo(d,0),o.lineTo(d,320),o.stroke();for(let d=i;d<320;d+=i)o.beginPath(),o.moveTo(0,d),o.lineTo(320,d),o.stroke();o.strokeStyle="#cc3333",o.lineWidth=4,o.globalAlpha=.7;for(let d=0;d<=320;d+=u)o.strokeStyle="#cc3333",o.lineWidth=8,o.globalAlpha=.2,o.beginPath(),o.moveTo(d,0),o.lineTo(d,320),o.stroke(),o.strokeStyle="#dd4444",o.lineWidth=4,o.globalAlpha=.7,o.beginPath(),o.moveTo(d,0),o.lineTo(d,320),o.stroke();for(let d=0;d<=320;d+=u)o.strokeStyle="#cc3333",o.lineWidth=8,o.globalAlpha=.2,o.beginPath(),o.moveTo(0,d),o.lineTo(320,d),o.stroke(),o.strokeStyle="#dd4444",o.lineWidth=4,o.globalAlpha=.7,o.beginPath(),o.moveTo(0,d),o.lineTo(320,d),o.stroke();const c=new ct(n);c.wrapS=et,c.wrapT=et,c.magFilter=Ge,c.minFilter=Ge;const h=a/16;return c.repeat.set(h,h),c},[a]);return r.jsxs("group",{children:[r.jsxs("mesh",{rotation:[-Math.PI/2,0,0],position:[0,-1,0],receiveShadow:!0,children:[r.jsx("planeGeometry",{args:[a,a]}),r.jsx("meshStandardMaterial",{map:s,color:"#ffffff",roughness:.7,metalness:0,transparent:!1,emissive:"#111111"})]}),[{pos:[0,0,-a/2],size:[a,4,1]},{pos:[0,0,a/2],size:[a,4,1]},{pos:[a/2,0,0],size:[1,4,a]},{pos:[-a/2,0,0],size:[1,4,a]}].map((n,o)=>r.jsxs("mesh",{position:n.pos,receiveShadow:!0,castShadow:!0,children:[r.jsx("boxGeometry",{args:n.size}),r.jsx("meshStandardMaterial",{color:"#444444",roughness:.8,metalness:.2,transparent:!0,opacity:.8})]},o))]})},Ys=({remoteDice:a,PhysicsDiceComponent:e})=>r.jsx(r.Fragment,{children:Array.from(a.entries()).map(([t,s])=>r.jsx(e,{dice:s,canvasId:t},`remote-${t}`))}),Ks=({diceBody:a,meshRef:e,cameraRef:t,canvasRef:s})=>{const[n,o]=g.useState(!1),[i,u]=g.useState(!1),[c,h]=g.useState(null),[d,f]=g.useState(null),[p,l]=g.useState(null),[m,x]=g.useState(null),[v,N]=g.useState(new M(0,0,0)),[k,I]=g.useState([]),T=g.useCallback(b=>{if(!b.shiftKey)return;b.stopPropagation(),b.target&&"setPointerCapture"in b.target&&b.target.setPointerCapture(b.pointerId);const y=new M(a.position.x,a.position.y,a.position.z);l(y);const C=new M;e.current&&e.current.getWorldPosition(C),o(!0),h({x:b.clientX,y:b.clientY,time:Date.now(),worldPos:C}),f({x:b.clientX,y:b.clientY}),x(C.clone()),N(new M(0,0,0)),I([{pos:C.clone(),time:Date.now()}]),a.type=me.KINEMATIC,a.velocity.set(0,0,0),a.angularVelocity.set(0,0,0)},[a,e]),j=g.useCallback(b=>{if(n&&c&&e.current&&t.current&&s.current){f({x:b.clientX,y:b.clientY});const y=t.current,E=s.current.getBoundingClientRect(),A=b.clientX-c.x,Q=b.clientY-c.y,X=A/E.width*2,pe=-(Q/E.height)*2,Z=new M;y.getWorldDirection(Z);const Ve=new M;Ve.crossVectors(Z,y.up).normalize();const Ze=new M;Ze.crossVectors(Ve,Z).normalize();const Et=y.fov||75,Rt=y.aspect||1,At=y.position.distanceTo(c.worldPos),Je=2*Math.tan(Et*Math.PI/180/2)*At,Pt=Je*Rt/2,$t=Je/2,ze=new M;ze.addScaledVector(Ve,X*Pt),ze.addScaledVector(Ze,pe*$t);const fe=c.worldPos.clone();fe.add(ze),fe.y=Math.max(fe.y,.1),x(fe);const Vt=Date.now();I(zt=>[...zt,{pos:fe.clone(),time:Vt}].slice(-10))}},[n,c,e,t,s]),P=g.useCallback(b=>{if(n&&c&&d){a&&(a.type=me.DYNAMIC,a.wakeUp()),b.target&&"releasePointerCapture"in b.target&&b.target.releasePointerCapture(b.pointerId);let y=new M(0,0,0);if(k.length>=2){const A=k.slice(-5),Q=A[A.length-1].time-A[0].time;if(Q>0){const X=new M;X.subVectors(A[A.length-1].pos,A[0].pos),y=X.multiplyScalar(1e3/Q),y.multiplyScalar(1)}}y.length()<.5&&y.set(0,-1,0),a.velocity.set(y.x,y.y,y.z);const C=y.length(),E=Math.min(C*.3,10);a.angularVelocity.set((Math.random()-.5)*E+y.z*.05,(Math.random()-.5)*E,(Math.random()-.5)*E-y.x*.05),console.log("ðŸŽ² Dice thrown with controlled physics:",{throwVelocity:y.toArray(),throwSpeed:C,rotationIntensity:E})}o(!1),h(null),f(null),l(null),x(null),N(new M(0,0,0)),I([])},[n,c,d,a,k]),R=g.useCallback(()=>{u(!0)},[]),V=g.useCallback(()=>{u(!1),n&&(a.type=me.DYNAMIC,o(!1),h(null),f(null),l(null))},[n,a]);return[{isDragging:n,isHovered:i,dragStart:c,dragCurrent:d,originalPosition:p,targetPosition:m,velocity:v,positionHistory:k},{handlePointerDown:T,handlePointerMove:j,handlePointerUp:P,handlePointerEnter:R,handlePointerLeave:V}]},Xs=({diceBody:a,meshRef:e,targetPosition:t,isDragging:s=!1})=>{const n=g.useRef(0),o=g.useRef(new M),i=g.useRef(new Y);ke(u=>{if(!e.current||!a)return;const c=u.clock.elapsedTime,h=s?0:1/30;if(!(c-n.current<h))if(n.current=c,s&&t){const d=new M(a.position.x,a.position.y,a.position.z),f=new M;f.subVectors(t,d);let p=.08;f.y<0&&(p=Math.min(.15,p+Math.abs(f.y)*.02));const l=d.clone();l.lerp(t,p);const m=new M;m.subVectors(l,d),m.multiplyScalar(60),a.position.set(l.x,l.y,l.z);const x=m.length();if(x>.1){const v=new S(m.z,0,-m.x).unit(),N=x*.02;a.quaternion.setFromAxisAngle(v,N)}e.current.position.copy(a.position),e.current.quaternion.copy(a.quaternion)}else{const d=new M(a.position.x,a.position.y,a.position.z),f=new Y(a.quaternion.x,a.quaternion.y,a.quaternion.z,a.quaternion.w);(!d.equals(o.current)||!f.equals(i.current))&&(e.current.position.copy(d),e.current.quaternion.copy(f),o.current.copy(d),i.current.copy(f))}})},ie={DICE_SPAWN:"DICE_SPAWN",DICE_THROW:"DICE_THROW",DICE_SETTLE:"DICE_SETTLE",DICE_HIGHLIGHT:"DICE_HIGHLIGHT",DICE_REMOVE:"DICE_REMOVE",CANVAS_CLEAR:"CANVAS_CLEAR"},Qe={mode:"result",enablePhysicsSync:!1,enableHighlighting:!0,maxEventHistory:100,conflictResolution:"owner"};class Zs{constructor(e=Qe){$(this,"callbacks",null);$(this,"currentSessionId");$(this,"activeDice",new Map);$(this,"eventHistory",[]);$(this,"config");this.currentSessionId=Te(),this.config={...e}}updateConfig(e){this.config={...this.config,...e},console.log("ðŸ“¡ Updated sync configuration:",this.config)}getConfig(){return{...this.config}}setCallbacks(e){this.callbacks=e}processCanvasEvent(e){this.eventHistory.push(e),this.eventHistory.length>this.config.maxEventHistory&&this.eventHistory.shift();const t=e.userId===this.currentSessionId;if(console.log(`ðŸ“¡ Received canvas event: ${e.type} for dice ${e.diceId} from ${t?"local":"remote"} user ${e.userId}`),!this.shouldProcessEvent(e,t)){console.log(`ðŸ“¡ Skipping event ${e.type} due to sync configuration`);return}switch(e.type){case"DICE_SPAWN":this.handleDiceSpawn(e,t);break;case"DICE_THROW":this.handleDiceThrow(e,t);break;case"DICE_SETTLE":this.handleDiceSettle(e,t);break;case"DICE_HIGHLIGHT":this.handleDiceHighlight(e,t);break;case"DICE_REMOVE":this.handleDiceRemove(e,t);break;case"CANVAS_CLEAR":this.handleCanvasClear(e,t);break;default:console.warn(`Unknown canvas event type: ${e.type}`)}}shouldProcessEvent(e,t){return t?!0:!(this.config.mode==="result"&&![ie.DICE_SPAWN,ie.DICE_SETTLE,ie.DICE_REMOVE,ie.CANVAS_CLEAR].includes(e.type)||!this.config.enablePhysicsSync&&e.type===ie.DICE_THROW||!this.config.enableHighlighting&&e.type===ie.DICE_HIGHLIGHT)}handleDiceSpawn(e,t){if(!this.callbacks||!e.data)return;const s={canvasId:e.diceId,diceType:e.data.diceType||"d6",position:e.data.position||{x:0,y:5,z:0},velocity:e.data.velocity,result:e.data.result,isVirtual:e.data.isVirtual||!1,virtualRolls:e.data.virtualRolls,userId:e.userId,isLocal:t};this.activeDice.set(e.diceId,s),t||this.callbacks.onDiceSpawn(s)}handleDiceThrow(e,t){var n;if(!this.callbacks||!((n=e.data)!=null&&n.velocity))return;const s=this.activeDice.get(e.diceId);s&&(s.velocity=e.data.velocity),this.callbacks.onDiceThrow(e.diceId,e.data.velocity,e.userId)}handleDiceSettle(e,t){var n;if(!this.callbacks||!((n=e.data)!=null&&n.position)||e.data.result===void 0)return;const s=this.activeDice.get(e.diceId);s&&(s.position=e.data.position,s.result=e.data.result),this.callbacks.onDiceSettle(e.diceId,e.data.position,e.data.result,e.userId)}handleDiceHighlight(e,t){var s;!this.callbacks||!((s=e.data)!=null&&s.highlightColor)||this.callbacks.onDiceHighlight(e.diceId,e.data.highlightColor,e.userId)}handleDiceRemove(e,t){this.callbacks&&(this.activeDice.delete(e.diceId),t||this.callbacks.onDiceRemove(e.diceId,e.userId))}handleCanvasClear(e,t){this.callbacks&&(this.activeDice.clear(),t||this.callbacks.onCanvasClear(e.userId))}getActiveDice(){return Array.from(this.activeDice.values())}getDice(e){return this.activeDice.get(e)}getDiceByUser(e){return Array.from(this.activeDice.values()).filter(t=>t.userId===e)}getLocalDice(){return this.getDiceByUser(this.currentSessionId)}getRemoteDice(){return Array.from(this.activeDice.values()).filter(e=>e.userId!==this.currentSessionId)}getEventHistory(){return[...this.eventHistory]}getStats(){const e=Array.from(this.activeDice.values()),t={},s={};return e.forEach(n=>{t[n.userId]=(t[n.userId]||0)+1,s[n.diceType]=(s[n.diceType]||0)+1}),{totalDice:e.length,localDice:this.getLocalDice().length,remoteDice:this.getRemoteDice().length,diceByUser:t,diceByType:s}}clear(){this.activeDice.clear(),this.eventHistory=[]}}function Js(a,e){var i,u;const t=g.useRef(null);g.useEffect(()=>{if(!t.current){const c={...Qe,...e};t.current=new Zs(c)}t.current.setCallbacks(a)},[a,e]);const{loading:s,error:n}=ye(ws,{onData:({data:c})=>{var h;(h=c==null?void 0:c.data)!=null&&h.canvasEventsUpdated&&t.current&&t.current.processCanvasEvent(c.data.canvasEventsUpdated)},onError:c=>{console.error("Canvas sync subscription error:",c)}});g.useEffect(()=>()=>{t.current&&t.current.clear()},[]);const o=g.useCallback(c=>{t.current&&t.current.updateConfig(c)},[]);return{syncManager:t.current,isConnected:!s&&!n,error:n,updateSyncConfig:o,config:((i=t.current)==null?void 0:i.getConfig())||Qe,stats:((u=t.current)==null?void 0:u.getStats())||{totalDice:0,localDice:0,remoteDice:0,diceByUser:{},diceByType:{}}}}class en{constructor(){$(this,"remoteDiceInstances",new Map);$(this,"remotePlayers",new Map);$(this,"updateCallbacks",[]);$(this,"isInitialized",!1);$(this,"onDiceSettleCallback")}initialize(){this.isInitialized=!0}setOnDiceSettleCallback(e){this.onDiceSettleCallback=e}async spawnRemoteDice(e){if(this.isInitialized){if(e.isVirtual){console.log(`ðŸ“¡ Skipping physical spawn for virtual ${e.diceType} from user ${e.userId}`),this.updatePlayerDice(e);return}try{let t;const s={size:1};switch(e.diceType){case"d4":t=new Re(s);break;case"d6":t=new be(s);break;case"d8":t=new Ae(s);break;case"d10":t=new bt(s);break;case"d12":t=new vt(s);break;case"d20":t=new Pe(s);break;default:t=new be(s)}t.body.position.set(e.position.x,e.position.y,e.position.z),t.body.quaternion.set(Math.random()*.5,Math.random()*.5,Math.random()*.5,Math.random()*.5),t.body.quaternion.normalize(),F.addBody(t.body),t.body.linearDamping=.1,t.body.angularDamping=.1;const n=new S((Math.random()-.5)*8,Math.random()*4,(Math.random()-.5)*8);t.body.velocity.set(n.x,n.y,n.z);const o=new S((Math.random()-.5)*8,(Math.random()-.5)*8,(Math.random()-.5)*8);t.body.angularVelocity.set(o.x,o.y,o.z),t.body.wakeUp(),this.remoteDiceInstances.set(e.canvasId,t),this.updatePlayerDice(e),console.log(`ðŸ“¡ Spawned remote ${e.diceType} from user ${e.userId} at:`,e.position)}catch(t){console.error(`âŒ Failed to spawn remote ${e.diceType}:`,t)}}}applyRemoteDiceThrow(e,t){const s=this.remoteDiceInstances.get(e);s&&(s.body.velocity.set(t.x,t.y,t.z),s.body.wakeUp(),console.log(`ðŸ“¡ Applied remote throw to dice ${e}`))}applyRemoteDiceSettle(e,t,s){const n=this.remoteDiceInstances.get(e);if(n){if(n.body.position.set(t.x,t.y,t.z),n.body.velocity.set(0,0,0),n.body.angularVelocity.set(0,0,0),this.onDiceSettleCallback){const o=[t.x,t.y,t.z];this.onDiceSettleCallback(e,s,o)}console.log(`ðŸ“¡ Settled remote dice ${e} at result ${s}`)}}applyRemoteDiceHighlight(e,t){console.log(`ðŸ“¡ Highlighting dice ${e} with color ${t}`)}removeRemoteDice(e){const t=this.remoteDiceInstances.get(e);t&&(F.removeBody(t.body),this.remoteDiceInstances.delete(e),console.log(`ðŸ“¡ Removed remote dice ${e}`))}clearRemoteDice(){this.remoteDiceInstances.forEach(e=>{F.removeBody(e.body)}),this.remoteDiceInstances.clear(),this.remotePlayers.clear(),console.log("ðŸ“¡ Cleared all remote dice"),this.notifyUpdate()}clearPlayerDice(e){this.remotePlayers.delete(e),this.notifyUpdate(),console.log(`ðŸ“¡ Cleared dice for player ${e}`)}getAllRemoteDiceInstances(){return new Map(this.remoteDiceInstances)}getAllRemoteDice(){const e=[];return this.remotePlayers.forEach(t=>{e.push(...t.dice)}),e}getPlayerDice(e){const t=this.remotePlayers.get(e);return t?[...t.dice]:[]}getAllPlayers(){return Array.from(this.remotePlayers.values())}onUpdate(e){this.updateCallbacks.push(e)}offUpdate(e){const t=this.updateCallbacks.indexOf(e);t>-1&&this.updateCallbacks.splice(t,1)}getOperations(){return{spawnRemoteDice:this.spawnRemoteDice.bind(this),applyRemoteDiceThrow:this.applyRemoteDiceThrow.bind(this),applyRemoteDiceSettle:this.applyRemoteDiceSettle.bind(this),applyRemoteDiceHighlight:this.applyRemoteDiceHighlight.bind(this),removeRemoteDice:this.removeRemoteDice.bind(this),clearRemoteDice:this.clearRemoteDice.bind(this)}}updatePlayerDice(e){const t=e.userId;this.remotePlayers.has(t)||this.remotePlayers.set(t,{id:t,name:t,dice:[],lastActivity:Date.now()});const s=this.remotePlayers.get(t),n={id:e.canvasId,playerId:e.userId,playerName:t,diceType:e.diceType,position:e.position,rotation:{x:0,y:0,z:0,w:1},value:e.result,timestamp:Date.now(),diceInstance:this.remoteDiceInstances.get(e.canvasId)};s.dice.push(n),s.lastActivity=Date.now(),this.notifyUpdate()}notifyUpdate(){const e=this.getAllPlayers();this.updateCallbacks.forEach(t=>{try{t(e)}catch(s){console.error("Error in remote dice update callback:",s)}})}cleanupInactivePlayers(e=3e5){const t=Date.now();for(const[s,n]of this.remotePlayers.entries())t-n.lastActivity>e&&(n.dice.forEach(o=>{o.diceInstance&&this.removeRemoteDice(o.id)}),this.remotePlayers.delete(s));this.notifyUpdate()}}const tn=({isInitialized:a})=>{var o;const e=g.useRef(null),[t,s]=g.useState(new Map);g.useEffect(()=>{e.current||(e.current=new en),a&&e.current&&e.current.initialize()},[a]),g.useEffect(()=>{if(e.current){const i=()=>{const u=e.current.getAllRemoteDiceInstances();s(u)};return e.current.onUpdate(i),()=>{e.current&&e.current.offUpdate(i)}}},[]);const n=((o=e.current)==null?void 0:o.getOperations())||{spawnRemoteDice:async()=>{},applyRemoteDiceThrow:()=>{},applyRemoteDiceSettle:()=>{},applyRemoteDiceHighlight:()=>{},removeRemoteDice:()=>{},clearRemoteDice:()=>{}};return[t,n]},sn=({isConnected:a,error:e,stats:t})=>{const[s,n]=g.useState("connecting");return g.useEffect(()=>{n(e?"error":a?"connected":"connecting")},[a,e]),{status:s,isConnected:a,error:e,stats:t}},nn=({isInitialized:a,onDiceSettle:e})=>{const[t,s]=tn({isInitialized:a}),n={onDiceSpawn:g.useCallback(d=>{console.log(`ðŸ“¡ Remote dice spawn: ${d.diceType} from user ${d.userId}`),s.spawnRemoteDice(d)},[s]),onDiceThrow:g.useCallback((d,f,p)=>{console.log(`ðŸ“¡ Remote dice throw: ${d} from user ${p}`),s.applyRemoteDiceThrow(d,f)},[s]),onDiceSettle:g.useCallback((d,f,p,l)=>{if(console.log(`ðŸ“¡ Remote dice settle: ${d} = ${p} from user ${l}`),s.applyRemoteDiceSettle(d,f,p),e){const m=[f.x,f.y,f.z];e(d,p,m)}},[s,e]),onDiceHighlight:g.useCallback((d,f,p)=>{console.log(`ðŸ“¡ Remote dice highlight: ${d} color ${f} from user ${p}`),s.applyRemoteDiceHighlight(d,f)},[s]),onDiceRemove:g.useCallback((d,f)=>{console.log(`ðŸ“¡ Remote dice remove: ${d} from user ${f}`),s.removeRemoteDice(d)},[s]),onCanvasClear:g.useCallback(d=>{console.log(`ðŸ“¡ Remote canvas clear from user ${d}`),s.clearRemoteDice()},[s])},{isConnected:o,error:i,stats:u,...c}=Js(n),h=sn({isConnected:o,error:i||null,stats:u});return{remoteDice:t,remoteDiceOps:s,syncStatus:h,isConnected:o,error:i,stats:u,...c}};function on(a={}){const[e,t]=g.useState(!1),[s,n]=g.useState(!1),o=g.useRef(null);g.useEffect(()=>{o.current&&(o.current.enabled=!e)},[e]);const i=g.useCallback(()=>{t(p=>{const l=!p;return console.log(`ðŸ“· Camera ${l?"locked":"unlocked"}`),l})},[]),u=g.useCallback(()=>{o.current&&o.current.reset()},[]),c=g.useCallback(()=>{n(p=>!p)},[]),h=g.useCallback(p=>{if(o.current){const l=o.current,m={x:30,y:20,z:30},x={x:p.x+m.x,y:p.y+m.y,z:p.z+m.z},v=p;l.target.set(v.x,v.y,v.z),l.object&&(l.object.position.set(x.x,x.y,x.z),l.object.lookAt(v.x,v.y,v.z)),l.update(),console.log("ðŸ“· Camera jumped to position:",x,"looking at:",v)}},[]),d=g.useMemo(()=>({isFullScreen:s,isCameraLocked:e}),[s,e]),f=g.useMemo(()=>({toggleFullScreen:c,toggleCameraLock:i,resetCamera:u,jumpToPosition:h}),[c,i,u,h]);return[d,f,o]}const rn=()=>{const[a,e]=g.useState(new Map),t=g.useCallback((l,m,x,v,N)=>{e(k=>{const I=k.get(l);if(!I||!I.isVisible){const T=new Map(k);return T.set(l,{diceId:l,result:m,position:x,isVisible:!0,timestamp:Date.now(),originalPosition:[...x],rollId:v,isGroupSum:N}),console.log(`ðŸŽ² Showing ${N?"group sum":"result"} overlay for dice ${l}: ${m}`),T}return k})},[]),s=g.useCallback((l,m,x,v)=>{if(l.length===0)return;const N=l[0],k=v(N);k&&(e(I=>{const T=new Map(I);return l.forEach(j=>{T.delete(j)}),T.set(N,{diceId:N,result:m,position:k,isVisible:!0,timestamp:Date.now(),originalPosition:[...k],rollId:x,isGroupSum:!0}),T}),console.log(`ðŸŽ² Showing group sum overlay (${l.length} dice): ${m}`))},[]),n=g.useCallback((l,m)=>{e(x=>{const v=x.get(l);if(v&&v.isVisible){const N=new Map(x);return N.set(l,{...v,position:[m[0],m[1]+2,m[2]]}),N}return x})},[]),o=g.useCallback((l,m,x=3)=>{e(v=>{const N=v.get(l);if(!N||!N.originalPosition||!N.isVisible)return v;const[k,I,T]=N.originalPosition,[j,P,R]=m,V=Math.sqrt(Math.pow(j-k,2)+Math.pow(P-I,2)+Math.pow(R-T,2));if(V>x){console.log(`ðŸŽ² Hiding overlay for dice ${l} - moved too far (${V.toFixed(2)} > ${x})`);const z=new Map(v);return z.set(l,{...N,isVisible:!1}),z}return v})},[]),i=g.useCallback(l=>{e(m=>{const x=m.get(l);if(x&&x.isVisible){const v=new Map(m);return v.set(l,{...x,isVisible:!1}),console.log(`ðŸŽ² Hiding result overlay for dice ${l}`),v}return m})},[]),u=g.useCallback(l=>{e(m=>{if(m.has(l)){const x=new Map(m);return x.delete(l),console.log(`ðŸŽ² Removed result overlay for dice ${l}`),x}return m})},[]),c=g.useCallback(()=>{e(new Map),console.log("ðŸŽ² Cleared all result overlays")},[]),h=g.useCallback((l=1e4)=>{const m=Date.now();e(x=>{const v=new Map;for(const[N,k]of x.entries())m-k.timestamp<l&&v.set(N,k);return v})},[]),d=g.useCallback(()=>Array.from(a.values()),[a]),f=g.useCallback(l=>a.get(l),[a]),p=g.useCallback(l=>{const m=a.get(l);return m&&m.isVisible},[a]);return{overlays:d(),showResultOverlay:t,showGroupSumOverlay:s,updateOverlayPosition:n,checkDistanceAndHide:o,hideResultOverlay:i,removeResultOverlay:u,clearAllOverlays:c,cleanupOldOverlays:h,getOverlay:f,hasVisibleOverlay:p}},qe=()=>{const a=document.activeElement;if(!a)return!1;const e=a.tagName.toLowerCase();if(["input","textarea","select"].includes(e)||a.getAttribute("contenteditable")==="true")return!0;if(e==="input"){const s=a.type.toLowerCase();return["text","password","email","search","tel","url"].includes(s)}return!1},an=(a,e={enabled:!0,showHints:!0})=>{const t=g.useCallback(o=>{var i;if(e.enabled&&!qe()&&!(o.ctrlKey||o.altKey||o.metaKey))switch(o.code){case"Space":o.preventDefault(),a.toggleCameraLock(),s("Camera Lock Toggled","ðŸ”’");break;case"KeyF":o.preventDefault(),a.toggleFullScreen(),s("Fullscreen Toggled","â›¶");break;case"KeyV":o.preventDefault(),a.resetCamera(),s("Camera Reset","ðŸ“·");break;case"Escape":qe()&&((i=document.activeElement)==null||i.blur(),s("Input Unfocused","âŒ¨ï¸"));break}},[a,e.enabled]),s=g.useCallback((o,i)=>{if(!e.showHints)return;const u=document.createElement("div");u.className=`
            fixed top-4 left-1/2 transform -translate-x-1/2 z-50
            bg-gray-900 text-white px-4 py-2 rounded-lg shadow-lg
            border border-gray-600 text-sm font-medium
            animate-pulse pointer-events-none
        `,u.innerHTML=`${i} ${o}`,document.body.appendChild(u),setTimeout(()=>{u.parentNode&&u.parentNode.removeChild(u)},1500)},[e.showHints]);g.useEffect(()=>{if(e.enabled)return window.addEventListener("keydown",t),()=>{window.removeEventListener("keydown",t)}},[t,e.enabled]);const n=g.useCallback(()=>[{key:"Space",action:"Toggle Camera Lock",icon:"ðŸ”’"},{key:"F",action:"Toggle Fullscreen",icon:"â›¶"},{key:"V",action:"Reset Camera",icon:"ðŸ“·"},{key:"Esc",action:"Unfocus Input",icon:"âŒ¨ï¸"}],[]);return{isInputFocused:qe(),getHotkeyHints:n,showHotkeyFeedback:s}},ln=({diceId:a,result:e,position:t,isVisible:s,onAnimationComplete:n})=>{const[o,i]=g.useState("appearing");if(g.useEffect(()=>{if(!s){i("appearing");return}const c=setTimeout(()=>i("visible"),200),h=setTimeout(()=>i("fading"),2e3),d=setTimeout(()=>{n==null||n()},3e3);return()=>{clearTimeout(c),clearTimeout(h),clearTimeout(d)}},[s,n]),!s)return null;const u=[t[0],t[1]+2,t[2]];return r.jsx(dt,{position:u,center:!0,distanceFactor:8,style:{pointerEvents:"none"},children:r.jsx("div",{className:`
          bg-yellow-400 text-black px-3 py-2 rounded-lg font-bold text-xl
          shadow-lg border-2 border-yellow-600 transition-all duration-300
          select-none pointer-events-none
          ${o==="appearing"?"scale-0 opacity-0 transform translate-y-2":""}
          ${o==="visible"?"scale-110 opacity-100 transform translate-y-0":""}
          ${o==="fading"?"scale-100 opacity-60 transform translate-y-1":""}
        `,style:{transformOrigin:"center bottom",textShadow:"1px 1px 2px rgba(0,0,0,0.3)",minWidth:"2rem",textAlign:"center"},children:e})})};qt({EdgesGeometry:Yt});const it={d4:{name:"D4 (Tetrahedron)",emoji:"â–²",min:1,max:4,color:"#ff6b6b",isAvailable:!0,create:()=>new Re({size:1})},d6:{name:"D6 (Cube)",emoji:"â¬œ",min:1,max:6,color:"#4ecdc4",isAvailable:!0,create:()=>new be({size:1})},d8:{name:"D8 (Octahedron)",emoji:"ðŸ”¸",min:1,max:8,color:"#45b7d1",isAvailable:!0,create:()=>new Ae({size:1})},d10:{name:"D10 (Pentagonal Trapezohedron)",emoji:"ðŸ”Ÿ",min:1,max:10,color:"#96ceb4",isAvailable:!0,create:()=>new bt({size:1})},d12:{name:"D12 (Dodecahedron)",emoji:"â¬¡",min:1,max:12,color:"#feca57",isAvailable:!0,create:()=>new vt({size:1})},d20:{name:"D20 (Icosahedron)",emoji:"ðŸ”´",min:1,max:20,color:"#ff9ff3",isAvailable:!0,create:()=>new Pe({size:1})}},cn=({dice:a,canvasId:e})=>{const t=g.useRef(null),s=g.useRef(null),n=g.useRef(null),{highlightFromDice:o,isDiceHighlighted:i}=Ee();ke(v=>{s.current=v.camera,n.current=v.gl.domElement});const[u,c]=Ks({diceBody:a.body,meshRef:t,cameraRef:s,canvasRef:n});Xs({diceBody:a.body,meshRef:t,targetPosition:u.targetPosition,isDragging:u.isDragging});const h=e?i(e):!1,d=g.useCallback(v=>{v.stopPropagation(),console.log(`ðŸŽ² Dice clicked with canvasId: "${e}"`),e?o(e):console.warn("ðŸŽ² Dice clicked but no canvasId provided")},[e,o]),f=a.diceType.toLowerCase(),p=it[f],l=Gs[f];p||console.warn(`Unknown dice type: "${a.diceType}" (normalized: "${f}"). Available types:`,Object.keys(it));const m=(p==null?void 0:p.color)||"#888888",x=g.useCallback(v=>{c.handlePointerDown(v),d(v)},[c,d]);return l?r.jsx(l,{size:a.options.size,color:m,isHovered:u.isHovered,isHighlighted:h,onPointerDown:x,onPointerMove:c.handlePointerMove,onPointerUp:c.handlePointerUp,onPointerEnter:c.handlePointerEnter,onPointerLeave:c.handlePointerLeave,meshRef:t},`dice-${a.diceType}`):r.jsxs("mesh",{ref:t,castShadow:!0,receiveShadow:!0,onPointerDown:x,onPointerMove:c.handlePointerMove,onPointerUp:c.handlePointerUp,onPointerEnter:c.handlePointerEnter,onPointerLeave:c.handlePointerLeave,children:[r.jsx("boxGeometry",{args:[1,1,1]}),r.jsx("meshStandardMaterial",{color:m,roughness:u.isHovered||h?.1:.3,metalness:u.isHovered||h?.3:.1,emissive:h?m:u.isHovered?"#888888":"#000000",emissiveIntensity:h?.3:u.isHovered?.1:0})]},`dice-${a.diceType}`)},dn=({virtualDice:a,onVirtualDiceClick:e})=>{const{isDiceHighlighted:t}=Ee();return r.jsx(r.Fragment,{children:a.map(s=>{var i;const n=t(s.canvasId),o=s.position||{x:0,y:2,z:0};return r.jsxs("group",{children:[r.jsxs("mesh",{position:[o.x,o.y,o.z],onClick:()=>e==null?void 0:e(s.canvasId),children:[r.jsx("boxGeometry",{args:[1,1,1]}),r.jsx("meshStandardMaterial",{color:n?"#9333ea":"#7c3aed",roughness:.2,metalness:.1,emissive:n?"#7c3aed":"#000000",emissiveIntensity:n?.3:0,transparent:!0,opacity:.8})]}),n&&r.jsx(dt,{position:[o.x,o.y+2,o.z],center:!0,distanceFactor:10,children:r.jsxs("div",{className:"bg-purple-900 text-white rounded-lg p-3 shadow-xl border border-purple-400 min-w-48",children:[r.jsxs("div",{className:"flex items-center justify-between mb-2",children:[r.jsx("span",{className:"text-xs font-bold bg-purple-400 px-2 py-1 rounded",children:"VIRTUAL"}),r.jsxs("span",{className:"text-sm font-semibold",children:[((i=s.virtualRolls)==null?void 0:i.length)||0,"Ã—",s.diceType]})]}),r.jsxs("div",{className:"text-center mb-2",children:[r.jsx("div",{className:"text-2xl font-bold text-purple-200",children:s.result||0}),r.jsx("div",{className:"text-xs text-purple-300",children:"Total"})]}),s.virtualRolls&&s.virtualRolls.length>0&&r.jsxs("div",{className:"text-xs",children:[r.jsx("div",{className:"text-purple-300 mb-1",children:"Individual rolls:"}),r.jsxs("div",{className:"grid grid-cols-6 gap-1 max-h-16 overflow-y-auto",children:[s.virtualRolls.slice(0,12).map((u,c)=>r.jsx("div",{className:"bg-purple-700 text-center py-1 rounded",children:u},c)),s.virtualRolls.length>12&&r.jsxs("div",{className:"bg-purple-600 text-center py-1 rounded text-xs",children:["+",s.virtualRolls.length-12]})]})]})]})})]},s.canvasId)})})},un=({cameraState:a,cameraOperations:e,controlsRef:t})=>{const[s,n]=g.useState(!1),{remoteDice:o}=nn({isInitialized:s,onDiceSettle:(j,P,R)=>{console.log(`ðŸŽ² Remote dice ${j} settled with result ${P}, showing overlay`),p(j,P,R)}}),{setCameraJumpCallback:i,setGetDicePositionCallback:u,getActivities:c,isDiceHighlighted:h}=Ee(),d=se.useMemo(()=>{const j=[];return c().forEach(R=>{var V,z;(z=(V=R.roll)==null?void 0:V.canvasData)!=null&&z.dice&&R.roll.canvasData.dice.forEach(D=>{D.isVirtual&&j.push(D)})}),j},[c]),{overlays:f,showResultOverlay:p,showGroupSumOverlay:l,updateOverlayPosition:m,removeResultOverlay:x,hasVisibleOverlay:v}=rn(),N={toggleCameraLock:e.toggleCameraLock,toggleFullScreen:e.toggleFullScreen,resetCamera:e.resetCamera};an(N,{enabled:!0,showHints:!0}),g.useEffect(()=>{if(!s)return;const P=setInterval(()=>{const R=b=>{const y=o.get(b);if(y&&y.body)return[y.body.position.x,y.body.position.y,y.body.position.z];const C=d.find(E=>E.canvasId===b);return C&&C.position?[C.position.x,C.position.y,C.position.z]:null};(()=>{var C,E;const b=c(),y=new Map;for(const A of b)if((E=(C=A.roll)==null?void 0:C.canvasData)!=null&&E.dice){const Q=A.id,X=[];let pe=0;for(const Z of A.roll.canvasData.dice)!Z.isVirtual&&h(Z.canvasId)&&(X.push(Z.canvasId),pe+=Z.result||0);X.length>0&&y.set(Q,{diceIds:X,total:pe,rollId:Q})}return y})().forEach(({diceIds:b,total:y,rollId:C})=>{if(b.length>1)l(b,y,C,R);else if(b.length===1){const E=b[0],A=R(E);A&&!v(E)&&p(E,y,A,C,!1)}}),[...Array.from(o.keys()),...d.map(b=>b.canvasId)].forEach(b=>{h(b)||x(b)}),f.forEach(b=>{const y=R(b.diceId);y&&m(b.diceId,y)})},200);return()=>clearInterval(P)},[s,o,d,h,c,p,l,m,x,v,f]);const k=g.useCallback(j=>{console.log(`ðŸŽ² Virtual dice clicked: ${j}`)},[]);g.useEffect(()=>{i(e.jumpToPosition)},[i,e.jumpToPosition]),g.useEffect(()=>{u(P=>{const R=o.get(P);if(R&&R.body)return{x:R.body.position.x,y:R.body.position.y,z:R.body.position.z};const V=d.find(z=>z.canvasId===P);return V&&V.position?V.position:null})},[u,o,d]);const I=g.useCallback(j=>{n(j)},[]),T=r.jsx(r.Fragment,{children:r.jsxs(Gt,{className:a.isFullScreen?"h-screen w-screen":"w-full h-full",camera:{position:[12,36,72],fov:20},gl:{antialias:!0,alpha:!1},style:{backgroundColor:"#1a1f2c"},shadows:!0,onCreated:({scene:j})=>{j.background=new Wt("#1a1f2c")},children:[r.jsx(Qt,{ref:t,enabled:!a.isCameraLocked}),r.jsx("ambientLight",{intensity:.4}),r.jsx("directionalLight",{position:[5,10,5],intensity:1.2,castShadow:!0,"shadow-mapSize-width":4096,"shadow-mapSize-height":4096,"shadow-camera-far":100,"shadow-camera-left":-50,"shadow-camera-right":50,"shadow-camera-top":50,"shadow-camera-bottom":-50}),r.jsx("directionalLight",{position:[-5,5,-5],intensity:.3}),r.jsx("pointLight",{position:[0,5,0],intensity:.5}),r.jsxs(Qs,{onInitialized:I,children:[r.jsx(Ws,{}),r.jsx(Ys,{remoteDice:o,PhysicsDiceComponent:cn}),r.jsx(dn,{virtualDice:d,onVirtualDiceClick:k}),f.map(j=>r.jsx(ln,{diceId:j.diceId,result:j.result,position:j.position,isVisible:j.isVisible,onAnimationComplete:()=>x(j.diceId)},j.diceId))]})]})});return a.isFullScreen?r.jsx("div",{className:"fixed inset-0 z-50 bg-gray-900",children:T}):r.jsx("div",{className:"w-full h-full",children:r.jsxs("div",{className:"relative w-full h-full",children:[T,!s&&r.jsx("div",{className:"absolute inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center rounded-lg",children:r.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-4 text-center",children:[r.jsx("div",{className:"animate-spin text-3xl mb-2",children:"ðŸŽ²"}),r.jsx("div",{className:"text-gray-900 dark:text-white",children:"Initializing Physics..."})]})})]})})},lt=({children:a,side:e,className:t=""})=>r.jsx("div",{className:`
                h-full 
                bg-brand-background/80 
                backdrop-blur-sm 
                ${e==="left"?"border-r":"border-l"} 
                border-white/10
                pointer-events-auto
                ${t}
            `,children:r.jsx("div",{className:`h-full 
                [&_.card]:bg-brand-surface/70 
                [&_.card]:backdrop-blur-sm 
                [&_.card]:border-white/10
                [&_button]:bg-opacity-80 
                [&_button]:backdrop-blur-sm
                [&_input]:bg-opacity-80 
                [&_input]:backdrop-blur-sm
                [&_.bg-brand-surface]:bg-brand-surface/60
                [&_.bg-brand-background]:bg-brand-background/70
                [&_.border-brand-surface]:border-white/10
                [&_.text-brand-text]:text-white/90
                [&_.text-brand-text-muted]:text-white/70
                [&_.bg-orange-900\\/20]:bg-orange-900/30
                [&_.bg-blue-600]:bg-blue-600/80
                [&_.bg-green-600]:bg-green-600/80
                [&_.bg-red-600]:bg-red-600/80
                [&_.bg-gray-800]:bg-gray-800/80
                [&_.bg-white]:bg-white/80
            `,children:a})}),hn=({isCameraLocked:a,onToggleCameraLock:e,onResetCamera:t,onToggleFullScreen:s,isPeeking:n=!1})=>n?r.jsxs("div",{className:"space-y-3",children:[r.jsxs("div",{children:[r.jsx("h3",{className:"text-sm font-medium text-brand-text-muted mb-2",children:"Quick Camera Controls"}),r.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[r.jsx("button",{onClick:e,className:`${a?"bg-red-600 hover:bg-red-500":"bg-green-600 hover:bg-green-500"} text-white font-medium py-1.5 px-2 rounded transition-colors text-xs`,title:a?"Unlock camera - Space":"Lock camera - Space",children:a?"ðŸ”’":"ðŸ”“"}),r.jsx("button",{onClick:t,className:"bg-gray-600 hover:bg-gray-500 text-white font-medium py-1.5 px-2 rounded transition-colors text-xs",title:"Reset camera - V",children:"ðŸ“·"}),r.jsx("button",{onClick:s,className:"bg-blue-600 hover:bg-blue-500 text-white font-medium py-1.5 px-2 rounded transition-colors text-xs",title:"Fullscreen - F",children:"â›¶"})]})]}),r.jsx("div",{className:"p-2 bg-blue-900/20 rounded border-l-2 border-blue-500",children:r.jsxs("div",{className:"text-xs text-blue-300",children:[r.jsx("strong",{children:"Quick Keys:"})," Space (lock) â€¢ V (reset) â€¢ F (fullscreen) â€¢ Esc (unfocus)"]})})]}):r.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[r.jsxs("div",{children:[r.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[r.jsx("span",{className:"text-sm font-medium text-brand-text-muted",children:"Instructions"}),r.jsx("span",{className:"text-xs bg-blue-900/30 text-blue-300 px-2 py-1 rounded border border-blue-500/30",children:"Hotkeys"})]}),r.jsxs("div",{className:"space-y-3",children:[r.jsxs("div",{children:[r.jsx("h4",{className:"text-xs font-medium text-brand-text-muted mb-1",children:"Camera Navigation"}),r.jsxs("div",{className:"text-xs space-y-1 text-brand-text-muted",children:[r.jsxs("div",{children:["â€¢ ",r.jsx("strong",{children:"Left Click & Drag:"})," Rotate view"]}),r.jsxs("div",{children:["â€¢ ",r.jsx("strong",{children:"Right Click & Drag:"})," Pan camera"]}),r.jsxs("div",{children:["â€¢ ",r.jsx("strong",{children:"Mouse Wheel:"})," Zoom in/out"]}),r.jsxs("div",{children:["â€¢ ",r.jsx("strong",{children:"Shift + Click & Drag dice:"})," Throw dice"]})]})]}),r.jsxs("div",{className:"border-t border-brand-surface pt-2",children:[r.jsx("h4",{className:"text-xs font-medium text-brand-text-muted mb-1",children:"Keyboard Shortcuts"}),r.jsxs("div",{className:"text-xs space-y-1 text-brand-text-muted",children:[r.jsxs("div",{children:["â€¢ ",r.jsx("strong",{children:"Space:"})," Toggle camera lock"]}),r.jsxs("div",{children:["â€¢ ",r.jsx("strong",{children:"V:"})," Reset camera view"]}),r.jsxs("div",{children:["â€¢ ",r.jsx("strong",{children:"F:"})," Toggle fullscreen"]}),r.jsxs("div",{children:["â€¢ ",r.jsx("strong",{children:"Esc:"})," Unfocus input fields"]})]})]})]})]}),r.jsxs("div",{children:[r.jsx("h3",{className:"text-sm font-medium text-brand-text-muted mb-3",children:"Camera Controls"}),r.jsx("div",{className:"p-2 bg-blue-900/20 rounded border-l-2 border-blue-500 mb-3",children:r.jsxs("div",{className:"text-xs text-blue-300",children:[r.jsx("strong",{children:"Status:"})," ",a?"Locked - Click dice freely":"Free - Mouse controls view"]})}),r.jsx("div",{className:"text-xs text-brand-text-muted mb-3",children:"ðŸ’¡ Lock the camera when you want to interact with dice without accidentally moving the view"}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs("button",{onClick:e,className:`w-full ${a?"bg-red-600 hover:bg-red-500":"bg-green-600 hover:bg-green-500"} text-white font-medium py-2 px-3 rounded transition-colors text-sm`,title:a?"Unlock camera (enable rotation/pan) - Hotkey: Space":"Lock camera (disable rotation/pan) - Hotkey: Space",children:[a?"ðŸ”’ Locked":"ðŸ”“ Free",r.jsx("span",{className:"ml-1 opacity-60 text-xs",children:"(Space)"})]}),r.jsxs("button",{onClick:t,className:"w-full bg-gray-600 hover:bg-gray-500 text-white font-medium py-2 px-3 rounded transition-colors text-sm",title:"Reset camera view - Hotkey: V",children:["ðŸ“· Reset",r.jsx("span",{className:"ml-1 opacity-60 text-xs",children:"(V)"})]}),r.jsxs("button",{onClick:s,className:"w-full bg-blue-600 hover:bg-blue-500 text-white font-medium py-2 px-3 rounded transition-colors text-sm",title:"Toggle fullscreen mode - Hotkey: F",children:["â›¶ Fullscreen",r.jsx("span",{className:"ml-1 opacity-60 text-xs",children:"(F)"})]})]})]})]}),mn=({onQuickRoll:a,isPeeking:e=!1})=>{const[t,s]=g.useState(1),[n,o]=g.useState("1"),i=[{type:4,emoji:"â–²",name:"D4",color:"bg-slate-600 hover:bg-slate-500"},{type:6,emoji:"â¬œ",name:"D6",color:"bg-slate-600 hover:bg-slate-500"},{type:8,emoji:"ðŸ”¸",name:"D8",color:"bg-slate-600 hover:bg-slate-500"},{type:10,emoji:"ðŸ”Ÿ",name:"D10",color:"bg-slate-600 hover:bg-slate-500"},{type:12,emoji:"â¬¡",name:"D12",color:"bg-slate-600 hover:bg-slate-500"},{type:20,emoji:"ðŸ”´",name:"D20",color:"bg-slate-600 hover:bg-slate-500"}],u=l=>{const m=Math.max(1,Math.min(1e3,l));return s(m),o(m.toString()),m},c=l=>{u(l)},h=l=>{const m=l.target.value;o(m);const x=parseInt(m);!isNaN(x)&&x>0&&s(Math.max(1,Math.min(1e3,x)))},d=()=>{const l=parseInt(n);isNaN(l)||l<1?u(1):u(l)},f=l=>{!/[0-9]/.test(l.key)&&!["Backspace","Delete","ArrowLeft","ArrowRight","Tab","Enter"].includes(l.key)&&l.preventDefault(),l.key==="Enter"&&l.currentTarget.blur()},p=l=>{const m=`/roll ${t}d${l}`;a&&a(m)};return e?r.jsx("div",{children:r.jsxs("div",{children:[r.jsx("h3",{className:"text-sm font-medium text-brand-text-muted mb-2",children:"Quick Dice Rolls"}),r.jsx("div",{className:"grid grid-cols-3 gap-2",children:i.slice(0,6).map(l=>r.jsxs("button",{className:`${l.color} text-white font-medium py-1.5 px-2 rounded transition-colors text-xs flex items-center justify-center gap-1`,onClick:()=>p(l.type),title:`Roll ${t}d${l.type}`,children:[r.jsx("span",{className:"text-xs",children:l.emoji}),r.jsxs("span",{children:[t,"d",l.type]})]},l.type))})]})}):r.jsxs("div",{className:"space-y-4",children:[r.jsx("div",{className:"p-3 bg-blue-900/20 rounded border-l-4 border-blue-500",children:r.jsxs("div",{className:"flex items-start gap-2",children:[r.jsx("span",{className:"text-blue-400 text-sm",children:"ðŸŽ²"}),r.jsxs("div",{className:"text-xs text-blue-300",children:[r.jsx("strong",{children:"Shared Dice Commands:"})," These controls generate ",r.jsx("code",{children:"/roll"})," commands that create dice visible to all players in the session. Results appear in chat and on the canvas. Shift + Click & Drag to pick up and throw dice yourself! (Purely cosmetic, does not propagate to other players)"]})]})}),r.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[r.jsx("div",{className:"bg-brand-background/50 rounded-lg p-3 border border-white/10",children:r.jsxs("div",{className:"text-center",children:[r.jsx("span",{className:"text-sm font-medium text-brand-text block mb-2",children:"Number of Dice"}),r.jsxs("div",{className:"flex items-center justify-center gap-2",children:[r.jsx("button",{onClick:()=>c(t-1),className:"w-8 h-8 bg-gray-600 hover:bg-gray-500 text-white rounded text-sm flex items-center justify-center font-bold",disabled:t<=1,children:"âˆ’"}),r.jsx("input",{type:"text",value:n,onChange:h,onBlur:d,onKeyDown:f,className:"w-12 text-center text-lg font-bold text-brand-text bg-brand-surface rounded px-2 py-1 border border-white/20 focus:border-blue-400 focus:outline-none",title:"Enter 1-1000 dice (large rolls use virtual dice)"}),r.jsx("button",{onClick:()=>c(t+1),className:"w-8 h-8 bg-gray-600 hover:bg-gray-500 text-white rounded text-sm flex items-center justify-center font-bold",disabled:t>=1e3,children:"+"})]}),r.jsx("div",{className:"text-xs text-brand-text-muted mt-1",children:t>10?"Virtual dice":"Physical dice"})]})}),r.jsxs("div",{className:"col-span-2",children:[r.jsx("h3",{className:"text-sm font-medium text-brand-text-muted mb-3",children:"Dice Types"}),r.jsx("div",{className:"grid grid-cols-3 gap-2",children:i.map(l=>r.jsxs("button",{onClick:()=>p(l.type),className:`
                                    ${l.color} 
                                    text-white 
                                    px-2 
                                    py-2 
                                    rounded 
                                    font-medium 
                                    transition-colors 
                                    flex 
                                    items-center 
                                    justify-center 
                                    gap-1
                                    text-sm
                                `,title:`Roll ${t}d${l.type} - creates shared dice visible to all players`,children:[r.jsx("span",{className:"text-sm",children:l.emoji}),r.jsx("span",{children:l.name})]},l.type))})]})]})]})},gn=({onQuickRoll:a,isCameraLocked:e,onToggleCameraLock:t,onResetCamera:s,onToggleFullScreen:n})=>{const[o,i]=g.useState(null),[u,c]=g.useState(null),[h,d]=g.useState(0),f=g.useRef(null),p=v=>{i(o===v?null:v)},l=o||u,m=o!==null,x=!m&&u!==null;return g.useEffect(()=>{if(f.current&&l){const v=f.current.scrollHeight;d(v)}else d(0)},[l,m,x]),r.jsxs("div",{className:"absolute bottom-0 left-0 right-0 z-20",children:[r.jsxs("div",{className:"flex bg-brand-surface/90 backdrop-blur-sm border-t border-white/10",children:[r.jsxs("button",{onClick:()=>p("dice"),onMouseEnter:()=>c("dice"),onMouseLeave:()=>c(null),className:`
                        flex-1 px-4 py-3 flex items-center justify-center gap-2 text-left 
                        transition-all duration-200 border-r border-white/10
                        ${l==="dice"?"bg-brand-surface text-brand-text shadow-lg":"hover:bg-brand-surface/50 text-brand-text-muted hover:text-brand-text"}
                    `,title:o==="dice"?"Collapse Dice Controls":x&&u==="dice"?"Click to expand Dice Controls":"Dice Controls (hover to peek)",children:[r.jsx("span",{className:"text-lg",children:"ðŸŽ²"}),r.jsx("span",{className:"font-medium",children:x&&u==="dice"?"Dice Controls (Click to expand)":"Dice Controls"}),r.jsx("span",{className:`transition-all duration-300 ml-auto ${o==="dice"?"rotate-180 text-brand-text":x&&u==="dice"?"rotate-90 text-brand-text-muted":"rotate-0 text-brand-text-muted"}`,children:"â–²"})]}),r.jsxs("button",{onClick:()=>p("camera"),onMouseEnter:()=>c("camera"),onMouseLeave:()=>c(null),className:`
                        flex-1 px-4 py-3 flex items-center justify-center gap-2 text-left 
                        transition-all duration-200
                        ${l==="camera"?"bg-brand-surface text-brand-text shadow-lg":"hover:bg-brand-surface/50 text-brand-text-muted hover:text-brand-text"}
                    `,title:o==="camera"?"Collapse Canvas Controls":x&&u==="camera"?"Click to expand Canvas Controls":"Canvas Controls (hover to peek)",children:[r.jsx("span",{className:"text-lg",children:"ðŸ“·"}),r.jsx("span",{className:"font-medium",children:x&&u==="camera"?"Canvas Controls (Click to expand)":"Canvas Controls"}),r.jsx("span",{className:`transition-all duration-300 ml-auto ${o==="camera"?"rotate-180 text-brand-text":x&&u==="camera"?"rotate-90 text-brand-text-muted":"rotate-0 text-brand-text-muted"}`,children:"â–²"})]})]}),r.jsx("div",{className:`
                    overflow-hidden 
                    transition-all 
                    duration-500
                    ease-out
                    bg-brand-surface/90 
                    backdrop-blur-sm 
                    border-t 
                    border-white/10
                `,style:{height:l?`${h}px`:"0px",opacity:l?m?1:.75:0,boxShadow:l?m?"0 25px 50px -12px rgba(0, 0, 0, 0.25)":"0 10px 15px -3px rgba(0, 0, 0, 0.1)":"none"},onMouseEnter:()=>{x&&c(l)},onMouseLeave:()=>{x&&c(null)},children:r.jsxs("div",{ref:f,className:`p-4 transition-all duration-500 ease-out ${x?"scale-95 opacity-80":"scale-100 opacity-100"}`,children:[l==="dice"&&r.jsx(mn,{onQuickRoll:a,isPeeking:x}),l==="camera"&&r.jsx(hn,{isCameraLocked:e,onToggleCameraLock:t,onResetCamera:s,onToggleFullScreen:n,isPeeking:x})]})})]})},pn=()=>{const a=g.useRef(null),[e,t,s]=on(),n=o=>{a.current&&a.current.populateCommand(o)};return r.jsxs("div",{className:"min-h-screen bg-brand-background text-brand-text flex flex-col",children:[r.jsx(vs,{}),r.jsxs("main",{className:"flex-grow h-0 relative",children:[r.jsx("div",{className:"absolute inset-0",children:r.jsx(un,{cameraState:e,cameraOperations:t,controlsRef:s})}),r.jsx("div",{className:"h-full relative z-10",style:{pointerEvents:"none"},children:r.jsxs(Xt,{direction:"horizontal",autoSaveId:"dice-roller-layout",className:"h-full",children:[r.jsx(Ue,{id:"activity-feed",defaultSize:25,minSize:20,maxSize:40,order:1,children:r.jsx(lt,{side:"left",className:"p-4",children:r.jsx(Es,{onQuickRoll:n,chatInputRef:a})})}),r.jsx(tt,{className:"w-1 bg-white/20 hover:bg-white/40 transition-colors relative z-20",style:{pointerEvents:"auto"}}),r.jsx(Ue,{id:"canvas-spacer",order:2,children:r.jsx("div",{className:"h-full relative",style:{pointerEvents:"none"},children:r.jsx("div",{className:"absolute bottom-0 left-0 right-0",style:{pointerEvents:"auto"},children:r.jsx(gn,{onQuickRoll:n,isCameraLocked:e.isCameraLocked,onToggleCameraLock:t.toggleCameraLock,onResetCamera:t.resetCamera,onToggleFullScreen:t.toggleFullScreen})})})}),r.jsx(tt,{className:"w-1 bg-white/20 hover:bg-white/40 transition-colors relative z-20",style:{pointerEvents:"auto"}}),r.jsx(Ue,{id:"lobby",defaultSize:25,minSize:20,maxSize:40,order:3,children:r.jsx(lt,{side:"right",className:"p-4",children:r.jsx(fn,{})})})]})})]})]})},fn=()=>{const[a,e]=g.useState(()=>{const s=localStorage.getItem("dice-roller-auto-scroll");return s!==null?JSON.parse(s):!0}),t=s=>{e(s),localStorage.setItem("dice-roller-auto-scroll",JSON.stringify(s)),window.dispatchEvent(new CustomEvent("autoScrollChanged",{detail:s}))};return r.jsxs("div",{className:"h-full p-4 space-y-4 overflow-y-auto",children:[r.jsxs("div",{className:"bg-brand-surface/50 rounded-lg p-3 border border-white/10",children:[r.jsx("h3",{className:"text-sm font-medium text-brand-text mb-2 flex items-center gap-2",children:"ðŸ  Room Information"}),r.jsxs("div",{className:"space-y-1 text-xs text-brand-text-muted",children:[r.jsxs("div",{className:"flex justify-between",children:[r.jsx("span",{children:"Status:"}),r.jsx("span",{className:"text-green-400",children:"ðŸŸ¢ Connected"})]}),r.jsxs("div",{className:"flex justify-between",children:[r.jsx("span",{children:"Room ID:"}),r.jsx("span",{className:"font-mono",children:"dice-lobby"})]})]})]}),r.jsxs("div",{className:"bg-brand-surface/50 rounded-lg p-3 border border-white/10",children:[r.jsx("h4",{className:"text-sm font-medium text-brand-text mb-3 flex items-center gap-2",children:"ðŸ‘¥ Active Players"}),r.jsx(xn,{})]}),r.jsxs("div",{className:"bg-brand-surface/50 rounded-lg p-3 border border-white/10",children:[r.jsx("h3",{className:"text-sm font-medium text-brand-text mb-3 flex items-center gap-2",children:"ðŸ‘¤ User Profile"}),r.jsx(Ms,{onQuickRoll:()=>{},hideQuickRollCommands:!0,showOnlyUserSettings:!0})]}),r.jsxs("div",{className:"bg-brand-surface/50 rounded-lg p-3 border border-white/10",children:[r.jsx("h4",{className:"text-sm font-medium text-brand-text mb-3 flex items-center gap-2",children:"âš™ï¸ Preferences"}),r.jsx("div",{className:"space-y-3",children:r.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[r.jsx("input",{type:"checkbox",className:"rounded border-gray-600 bg-brand-background text-brand-primary focus:ring-brand-primary focus:ring-offset-0",checked:a,onChange:s=>t(s.target.checked)}),r.jsx("span",{className:"text-brand-text-muted",children:"Auto-scroll chat to bottom"})]})})]})]})},xn=()=>{const[a,e]=g.useState([]);return Me(Ie,{onCompleted:t=>{e(t.activeUsers)}}),ye(Ke,{onData:({data:t})=>{var n;const s=(n=t==null?void 0:t.data)==null?void 0:n.userListChanged;s&&e(s)}}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs("div",{className:"text-xs text-brand-text-muted mb-2",children:[a.length," player",a.length!==1?"s":""," connected"]}),a.map(t=>r.jsxs("div",{className:"flex items-center gap-2 p-2 bg-brand-background/50 rounded",children:[r.jsx("div",{className:"w-3 h-3 rounded-full border border-gray-400",style:{backgroundColor:t.color||"#ffffff"},title:`${t.username}'s color`}),r.jsx("span",{className:"text-brand-text text-sm",children:t.username}),t.isActive&&r.jsx("span",{className:"text-xs text-green-400 bg-green-900/30 px-2 py-1 rounded",children:"Online"})]},t.sessionId)),a.length===0&&r.jsx("div",{className:"text-center text-brand-text-muted text-sm py-4",children:"No players connected"})]})};function yn(){return r.jsx(pn,{})}function bn(a){return mt(a)&&"code"in a&&"reason"in a}function wn(a){var e;return mt(a)&&((e=a.target)===null||e===void 0?void 0:e.readyState)===WebSocket.CLOSED}var vn=function(a){Zt(e,a);function e(t){var s=a.call(this)||this;return s.client=t,s}return e.prototype.request=function(t){var s=this;return new ut(function(n){return s.client.subscribe(st(st({},t),{query:Jt(t.query)}),{next:n.next.bind(n),complete:n.complete.bind(n),error:function(o){if(o instanceof Error)return n.error(o);var i=bn(o);return i||wn(o)?n.error(new Error("Socket closed".concat(i?" with event ".concat(o.code):"").concat(i?" ".concat(o.reason):""))):n.error(new es({graphQLErrors:Array.isArray(o)?o:[o]}))}})})},e}(ht),Dn=function(){var a=function(e,t){return a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(s,n){s.__proto__=n}||function(s,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(s[o]=n[o])},a(e,t)};return function(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");a(e,t);function s(){this.constructor=e}e.prototype=t===null?Object.create(t):(s.prototype=t.prototype,new s)}}(),Cn=function(a){Dn(e,a);function e(t,s,n){n===void 0&&(n=408);var o=a.call(this,t)||this;return o.timeout=s,o.statusCode=n,o}return e}(Error),jn=function(){var a=function(e,t){return a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(s,n){s.__proto__=n}||function(s,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(s[o]=n[o])},a(e,t)};return function(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");a(e,t);function s(){this.constructor=e}e.prototype=t===null?Object.create(t):(s.prototype=t.prototype,new s)}}(),he=function(){return he=Object.assign||function(a){for(var e,t=1,s=arguments.length;t<s;t++){e=arguments[t];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(a[n]=e[n])}return a},he.apply(this,arguments)},Sn=15e3,Nn=function(a){jn(e,a);function e(t,s){var n=a.call(this)||this;return n.timeout=t||Sn,n.statusCode=s,n}return e.prototype.request=function(t,s){var n=this,o,i,u=t.getContext().timeout||this.timeout;if(typeof AbortController<"u"){var c=t.getContext(),h=c.fetchOptions||{};i=new AbortController,o=h.controller||i,h=he(he({},h),{controller:o,signal:o.signal}),t.setContext({fetchOptions:h})}var d=s(t),f=t.query.definitions.find(function(l){return l.kind==="OperationDefinition"}).operation;if(u<=0||f==="subscription")return d;var p=new ut(function(l){var m,x=d.subscribe(function(k){clearTimeout(m),l.next(k),l.complete()},function(k){clearTimeout(m),l.error(k),l.complete()});m=setTimeout(function(){if(o){if(o.signal.aborted)return;o.abort();var k=t.getContext(),I=k.fetchOptions||{};I.controller===i&&I.signal===i.signal&&t.setContext(he(he({},I),{controller:void 0,signal:void 0}))}l.error(new Cn("Timeout exceeded",u,n.statusCode)),x.unsubscribe()},u);var v=function(){clearTimeout(m),x.unsubscribe()},N=t.getContext().timeoutRef;return N&&N({unsubscribe:v}),o.signal.addEventListener("abort",function(){v()},{once:!0}),v});return p},e}(ht);const Xe=Te();console.log("Using session ID:",Xe);const Tt=window.location.host,kn=window.location.protocol==="https:"?"https":"http",Mn=window.location.protocol==="https:"?"wss":"ws",In=new ts({uri:`${kn}://${Tt}/dice/graphql`,headers:{"x-session-id":Xe}}),Tn=new Nn(5e3),En=ss([Tn,In]),we=ns({url:`${Mn}://${Tt}/dice/graphql`,connectionParams:{sessionId:Xe},keepAlive:1e4}),Rn=new vn(we);window.addEventListener("beforeunload",a=>{console.log("Tab is closing, cleaning up WebSocket connection..."),we&&(we.dispose(),console.log("WebSocket connection disposed")),a.preventDefault(),a.returnValue=""});const An=os(({query:a})=>{const e=rs(a);return e.kind==="OperationDefinition"&&e.operation==="subscription"},Rn,En),Pn=new as({link:An,cache:new is});function $n(){return g.useEffect(()=>()=>{console.log("App component unmounting, cleaning up connections..."),we&&we.dispose()},[]),r.jsx(g.StrictMode,{children:r.jsx(ls,{client:Pn,children:r.jsx(yn,{})})})}Kt.createRoot(document.getElementById("root")).render(r.jsx($n,{}));
